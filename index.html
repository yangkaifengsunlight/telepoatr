<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIæ™ºèƒ½æè¯å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* å¼ºåˆ¶ä½¿ç”¨æ·±è‰²èƒŒæ™¯ï¼Œæé«˜é˜…è¯»å¯¹æ¯”åº¦ */
      body {
        font-family: "Inter", sans-serif;
        background-color: #1f2937; /* Gray-800 */
      }
      /* å®šåˆ¶æ»šåŠ¨æ¡å¤–è§‚ */
      .scrolling-content::-webkit-scrollbar {
        width: 8px;
      }
      .scrolling-content::-webkit-scrollbar-thumb {
        background-color: #4b5563; /* Gray-600 */
        border-radius: 4px;
      }
      .scrolling-content::-webkit-scrollbar-track {
        background: #374151; /* Gray-700 */
      }
      /* æè¯å™¨å†…å®¹åŒºåŸŸï¼Œå®ç°å…¨å±å±…ä¸­é˜…è¯»æ•ˆæœ */
      #teleprompter-display {
        position: relative;
        height: calc(100vh - 280px); /* å‡å»æ§åˆ¶é¢æ¿çš„é«˜åº¦ */
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 1rem;
      }
      /* ç”¨äºå®šä½å±…ä¸­çº¿ */
      #center-line {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        border-top: 2px dashed #fcd34d; /* Amber-300 */
        z-index: 10;
      }
      /* å†…å®¹å®¹å™¨ï¼Œå…è®¸å†…éƒ¨å†…å®¹å‚ç›´å±…ä¸­å®šä½ */
      #script-content-wrapper {
        width: 100%;
        max-width: 900px;
        height: 100%;
        overflow-y: scroll;
        scroll-behavior: smooth;
        padding-top: 50vh; /* ç¡®ä¿ç¬¬ä¸€è¡Œå†…å®¹å¯ä»¥æ»šåŠ¨åˆ°ä¸­é—´ */
        padding-bottom: 50vh; /* ç¡®ä¿æœ€åä¸€è¡Œå†…å®¹å¯ä»¥æ»šåŠ¨åˆ°ä¸­é—´ */
        /* åˆå§‹æ°´å¹³è¾¹è·å°†åœ¨JSä¸­è®¾ç½® */
        transition: transform 0.3s ease-out; /* å¹³æ»‘è¿‡æ¸¡é•œåƒæ•ˆæœ */
      }
      /* è„šæœ¬æ®µè½æ ·å¼ */
      .script-segment {
        transition: color 0.3s, transform 0.3s;
        text-align: center;
      }
      /* æ¿€æ´»æ®µè½æ ·å¼ */
      .active-segment {
        color: #fcd34d !important; /* Amber-300 */
        transform: scale(1.05);
      }
      /* è¯†åˆ«æç¤ºæ ·å¼ */
      .recognition-hint {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 50;
        padding: 0.5rem 1rem;
        background: rgba(251, 191, 36, 0.95); /* Amber-400 */
        color: #1f2937;
        border-radius: 9999px;
        font-weight: 600;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      .recognition-hint.visible {
        opacity: 1;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#fcd34d",
              secondary: "#374151",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl">
      <h1 class="text-3xl font-bold text-center mb-6 text-primary">
        AIæ™ºèƒ½æè¯å™¨ ğŸ™ï¸
      </h1>

      <!-- æè¯å™¨æ˜¾ç¤ºåŒº -->
      <div
        id="teleprompter-display"
        class="relative bg-gray-900 rounded-xl shadow-2xl border border-gray-700"
      >
        <div id="center-line"></div>
        <div id="script-content-wrapper" class="text-gray-300">
          <!-- è„šæœ¬å†…å®¹å°†åœ¨æ­¤å¤„æ’å…¥ -->
        </div>
        <div id="recognition-hint" class="recognition-hint">
          æ­£åœ¨å¬... è¯·è¯´å½“å‰æ®µè½
        </div>
      </div>

      <!-- çŠ¶æ€å’Œæç¤ºä¿¡æ¯ -->
      <div
        id="status-message"
        class="text-center mt-4 p-2 rounded-lg font-medium text-red-400"
      >
        <!-- çŠ¶æ€/é”™è¯¯ä¿¡æ¯ -->
      </div>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="bg-gray-800 p-4 rounded-xl mt-6 shadow-lg">
        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
          <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
          <button
            id="mode-toggle-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-yellow-600 hover:bg-yellow-500 text-gray-900 shadow-md"
          >
            åˆ‡æ¢åˆ° è¯­éŸ³æ¨¡å¼
          </button>

          <!-- NEW: é•œåƒåŠŸèƒ½æŒ‰é’® -->
          <button
            id="mirror-toggle-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-gray-600 hover:bg-gray-500 text-white shadow-md"
          >
            å¼€å¯é•œåƒ
          </button>

          <!-- å¯åŠ¨/åœæ­¢æŒ‰é’® -->
          <button
            id="start-stop-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-green-600 hover:bg-green-500 text-white shadow-md"
            disabled
          >
            å¯åŠ¨æ»šåŠ¨
          </button>

          <!-- é‡ç½®æŒ‰é’® -->
          <button
            id="reset-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-red-600 hover:bg-red-500 text-white shadow-md"
          >
            é‡ç½®ä½ç½®
          </button>
        </div>

        <!-- Control Row 1: æ»šåŠ¨é€Ÿåº¦ã€å­—ä½“å¤§å°ã€æ–‡æœ¬è¾¹è·ã€æ®µè½é—´è·æ§åˆ¶ -->
        <div class="flex flex-wrap justify-start items-center gap-6 mt-4">
          <!-- æ»šåŠ¨é€Ÿåº¦æ§åˆ¶ -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="scroll-speed"
              class="block text-sm font-medium text-gray-300"
              >æ»šåŠ¨é€Ÿåº¦ (<span id="speed-value">2</span>)</label
            >
            <input
              type="range"
              id="scroll-speed"
              min="0.5"
              max="5"
              step="0.5"
              value="2"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- å­—ä½“å¤§å°æ§åˆ¶ -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="font-size"
              class="block text-sm font-medium text-gray-300"
              >å­—ä½“å¤§å° (<span id="font-value">48px</span>)</label
            >
            <input
              type="range"
              id="font-size"
              min="20"
              max="96"
              step="4"
              value="48"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- æ–‡æœ¬è¾¹è·æ§åˆ¶ (Horizontal Padding) -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="text-padding"
              class="block text-sm font-medium text-gray-300"
              >æ–‡æœ¬è¾¹è·(å·¦å³) (<span id="padding-value">20px</span>)</label
            >
            <input
              type="range"
              id="text-padding"
              min="0"
              max="150"
              step="5"
              value="20"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- æ®µè½é—´è·æ§åˆ¶ (Vertical Margin) -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="paragraph-spacing"
              class="block text-sm font-medium text-gray-300"
              >æ®µè½é—´è·(å‚ç›´) (<span id="paragraph-value">20px</span>)</label
            >
            <input
              type="range"
              id="paragraph-spacing"
              min="5"
              max="100"
              step="5"
              value="20"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
        </div>

        <!-- Control Row 2: è¡Œé«˜æ§åˆ¶ -->
        <div
          class="flex flex-wrap justify-start items-center gap-6 mt-6 pt-4 border-t border-gray-700"
        >
          <!-- è¡Œé«˜æ§åˆ¶ (Line Height) -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="line-height-control"
              class="block text-sm font-medium text-gray-300"
              >è¡Œé«˜ (è¡Œå†…é—´è·) (<span id="line-height-value">1.5</span>)</label
            >
            <input
              type="range"
              id="line-height-control"
              min="1.0"
              max="2.5"
              step="0.1"
              value="1.5"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
        </div>

        <!-- æ–‡æœ¬è¾“å…¥åŒº, ç‹¬ç«‹ä¸€è¡Œ -->
        <div class="w-full mt-6">
          <label
            for="script-input"
            class="block text-sm font-medium text-gray-300"
            >æ¼”è®²ç¨¿å†…å®¹ (æ®µè½é—´è¯·ç”¨ç©ºè¡Œåˆ†éš”)</label
          >
          <textarea
            id="script-input"
            rows="4"
            class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-gray-200 focus:ring-primary focus:border-primary border border-gray-600"
          >
å„ä½è§‚ä¼—å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°ä»Šå¤©çš„åˆ†äº«ä¼šã€‚
ä¿¡æ¯æ—¶ä»£ï¼Œæˆ‘ä»¬å¸¸è¢«æ•°å­—ä¸–ç•Œçš„æ··ä¹±æ‰€å›°æ‰°ã€‚ä½ æ˜¯ä¸æ˜¯ä¹Ÿå¸¸è¢«ç”µè„‘ã€æ‰‹æœºã€ç½‘ç›˜é‡Œçš„æ–‡ä»¶æå¾—ç„¦å¤´çƒ‚é¢ï¼Ÿæ˜æ˜ä¿å­˜è¿‡çš„ä¸œè¥¿ï¼Œååæ€¥ç”¨æ—¶ç¿»éå…¨ç½‘éƒ½æ‰¾ä¸åˆ°ï¼Ÿ

åˆ«æ€¥ï¼Œä»Šå¤©æˆ‘è¦ç»™ä½ åˆ†äº«ä¸€ä¸ªè¶…ç®€å•çš„æ–¹æ³•â€”â€”PARAï¼
åªéœ€è¦4ä¸ªæ–‡ä»¶å¤¹ï¼Œå°±èƒ½è®©ä½ çš„æ•°å­—ç”Ÿæ´»ç¬é—´å˜æ¸…çˆ½ï¼Œæ‰¾ä¸œè¥¿å†ä¹Ÿä¸æŠ“ç‹‚ã€‚
é¡¹ç›®ï¼ˆProjectsï¼‰æ”¾ä½ çœ¼ä¸‹æ­£åœ¨å¿™çš„äº‹ã€‚
é¢†åŸŸï¼ˆAreasï¼‰æ”¾ä½ ç”Ÿæ´»ä¸­éœ€è¦æŒç»­å…³æ³¨çš„å¤§å—é¢†åŸŸã€‚
èµ„æºï¼ˆResourcesï¼‰æ”¾ä½ æ„Ÿå…´è¶£æˆ–æ­£åœ¨å­¦ä¹ çš„çŸ¥è¯†åº“ã€‚
å½’æ¡£ï¼ˆArchivesï¼‰æ”¾è¿‡å»å®Œæˆæˆ–æš‚æ—¶ç”¨ä¸ä¸Šçš„ä¸œè¥¿ã€‚

å¯¹ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ï¼è¿™å››ä¸ªæ–‡ä»¶å¤¹ï¼Œæ¶µç›–äº†ä½ æ•°å­—ç”Ÿæ´»çš„æ‰€æœ‰ä¸œè¥¿ã€‚å·¥ä½œä»»åŠ¡ã€ä¸ªäººå…´è¶£ï¼ŒPARAéƒ½èƒ½å¸®ä½ åˆ†å¾—æ¸…æ¸…æ¥šæ¥šã€‚
æˆ‘è‡ªå·±è¯•äº†ä»¥åï¼ŒçœŸçš„æœ‰ç§â€œæ•‘å‘½å•Šç»ˆäºæ‰¾åˆ°ç»„ç»‡ç¥å™¨â€çš„æ„Ÿè§‰ï¼è¯•ä¸€æ¬¡ï¼Œä½ å°±çŸ¥é“æœ‰å¤šçˆ½ï¼
æ„Ÿè°¢å¤§å®¶çš„æ”¶å¬ï¼ŒæœŸå¾…ä¸ä½ ä¸‹æœŸå†è§ï¼peaceï½
                </textarea
          >
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let scrollInterval = null;
      let isScrolling = false;
      let isVoiceMode = false;
      let isMirrored = false; // NEW: é•œåƒçŠ¶æ€
      let recognition = null;
      let scriptSegments = [];
      let currentSegmentIndex = 0;

      // DOM å…ƒç´ 
      const display = document.getElementById("script-content-wrapper");
      const input = document.getElementById("script-input");
      const startStopBtn = document.getElementById("start-stop-btn");
      const resetBtn = document.getElementById("reset-btn");
      const speedInput = document.getElementById("scroll-speed");
      const speedValue = document.getElementById("speed-value");
      const fontInput = document.getElementById("font-size");
      const fontValue = document.getElementById("font-value");
      const paddingInput = document.getElementById("text-padding");
      const paddingValue = document.getElementById("padding-value");
      const paragraphInput = document.getElementById("paragraph-spacing");
      const paragraphValue = document.getElementById("paragraph-value");
      const lineHeightInput = document.getElementById("line-height-control");
      const lineHeightValue = document.getElementById("line-height-value");
      const mirrorToggleBtn = document.getElementById("mirror-toggle-btn"); // NEW

      const statusMessage = document.getElementById("status-message");
      const modeToggleBtn = document.getElementById("mode-toggle-btn");
      const recognitionHint = document.getElementById("recognition-hint");

      // --- è¾…åŠ©å‡½æ•° ---

      /**
       * æ¸²æŸ“è„šæœ¬åˆ°æè¯å™¨æ˜¾ç¤ºåŒº
       */
      function renderScript() {
        const text = input.value;
        // ä½¿ç”¨ä¸¤ä¸ªæˆ–å¤šä¸ªæ¢è¡Œç¬¦æ¥åˆ†éš”æ®µè½
        const segments = text.split(/\n\s*\n/).filter((s) => s.trim() !== "");
        scriptSegments = segments.map((s) => s.trim());

        display.innerHTML = "";
        const currentParagraphSpacing = paragraphInput.value;
        const currentLineHeight = lineHeightInput.value;

        scriptSegments.forEach((segment, index) => {
          const div = document.createElement("div");
          div.className =
            "script-segment text-2xl md:text-3xl lg:text-4xl font-semibold opacity-70 transition-all duration-300";
          div.id = `segment-${index}`;
          div.innerText = segment;
          div.style.fontSize = `${fontInput.value}px`;
          div.style.marginBottom = `${currentParagraphSpacing}px`;
          div.style.lineHeight = currentLineHeight;

          // NEW: å¦‚æœå½“å‰å¤„äºé•œåƒçŠ¶æ€ï¼Œæ–°æ¸²æŸ“çš„æ®µè½ä¹Ÿè¦ç¿»è½¬å›æ¥
          if (isMirrored) {
            div.style.transform = "scaleX(-1)";
          }

          display.appendChild(div);
        });

        // é¦–æ¬¡æ¸²æŸ“åï¼Œé‡ç½®å¹¶æ¿€æ´»ç¬¬ä¸€ä¸ªæ®µè½
        resetPosition();
        updateActiveSegment();

        startStopBtn.disabled = scriptSegments.length === 0;
      }

      /**
       * æ›´æ–°å½“å‰æ´»åŠ¨çš„æ®µè½æ ·å¼
       */
      function updateActiveSegment() {
        document.querySelectorAll(".script-segment").forEach((el, index) => {
          el.classList.remove("active-segment", "opacity-100");
          el.classList.add("opacity-70");

          if (index === currentSegmentIndex) {
            el.classList.add("active-segment", "opacity-100");
          } else if (index < currentSegmentIndex) {
            // å·²è¯»è¿‡çš„æ®µè½å˜æ·¡
            el.classList.add("opacity-30");
          }
        });
      }

      /**
       * å¹³æ»‘æ»šåŠ¨åˆ°å½“å‰æ´»åŠ¨æ®µè½çš„ä¸­å¤®
       */
      function smoothScrollToActiveSegment() {
        const activeSegment = document.getElementById(
          `segment-${currentSegmentIndex}`
        );
        if (activeSegment) {
          // ä½¿ç”¨ scrollIntoView å±…ä¸­å¯¹é½
          activeSegment.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }
      }

      /**
       * æ£€æŸ¥ Web Speech API å…¼å®¹æ€§
       */
      function checkSpeechApi() {
        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          statusMessage.innerText =
            "âš ï¸ è­¦å‘Š: æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API (è¯­éŸ³è¯†åˆ«)ã€‚æ™ºèƒ½è¯­éŸ³æ¨¡å¼å°†ä¸å¯ç”¨ã€‚";
          modeToggleBtn.disabled = true;
          return false;
        }
        statusMessage.innerText = "";
        return true;
      }

      // --- æ ¸å¿ƒæ¨¡å¼é€»è¾‘ï¼šæ‰‹åŠ¨æ»šåŠ¨ ---

      function startScroll() {
        if (isScrolling) return;
        isScrolling = true;
        startStopBtn.innerText = "æš‚åœæ»šåŠ¨";
        startStopBtn.classList.remove("bg-green-600", "hover:bg-green-500");
        startStopBtn.classList.add("bg-orange-600", "hover:bg-orange-500");

        const speed = parseFloat(speedInput.value); // åƒç´ /å¸§

        scrollInterval = setInterval(() => {
          display.scrollTop += speed;

          // æ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åœæ­¢
          if (
            display.scrollTop + display.clientHeight >=
            display.scrollHeight - 5
          ) {
            stopScroll();
          }
        }, 30); // 30ms åˆ·æ–°ä¸€æ¬¡
      }

      function stopScroll() {
        if (!isScrolling) return;
        isScrolling = false;
        clearInterval(scrollInterval);
        startStopBtn.innerText = "å¯åŠ¨æ»šåŠ¨";
        startStopBtn.classList.remove("bg-orange-600", "hover:bg-orange-500");
        startStopBtn.classList.add("bg-green-600", "hover:bg-green-500");
      }

      // --- æ ¸å¿ƒæ¨¡å¼é€»è¾‘ï¼šè¯­éŸ³æ™ºèƒ½æ¨è¿› ---

      function initSpeechRecognition() {
        if (!checkSpeechApi()) return;

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false; // åªå¬ä¸€å¥
        recognition.interimResults = false; // åªè¿”å›æœ€ç»ˆç»“æœ
        recognition.lang = "zh-CN"; // è®¾ç½®ä¸­æ–‡è¯†åˆ«

        recognition.onstart = () => {
          recognitionHint.innerText = "ğŸ™ï¸ æ­£åœ¨å¬... è¯·è¯´å½“å‰æ®µè½";
          recognitionHint.classList.add("visible");
          statusMessage.innerText = "è¯­éŸ³æ¨¡å¼å·²å¯åŠ¨ï¼Œè¯·å¼€å§‹æœ—è¯»ã€‚";
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          console.log("è¯†åˆ«ç»“æœ:", transcript);
          checkAndAdvance(transcript);
        };

        recognition.onend = () => {
          recognitionHint.classList.remove("visible");
          if (isVoiceMode) {
            // å¦‚æœæœªå®Œæˆï¼Œè‡ªåŠ¨é‡æ–°å¯åŠ¨ç›‘å¬
            setTimeout(() => {
              if (isVoiceMode && currentSegmentIndex < scriptSegments.length) {
                try {
                  recognition.start();
                } catch (e) {
                  console.warn(
                    "Recognition already started, ignoring auto-restart."
                  );
                }
              } else if (currentSegmentIndex >= scriptSegments.length) {
                statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼";
              }
            }, 100);
          }
        };

        recognition.onerror = (event) => {
          console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
          statusMessage.innerText = `âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}. è¯·æ£€æŸ¥éº¦å…‹é£æƒé™ã€‚`;
          recognitionHint.classList.remove("visible");
          if (isVoiceMode) {
            // é”™è¯¯åå°è¯•é‡æ–°å¯åŠ¨
            setTimeout(() => {
              if (isVoiceMode && currentSegmentIndex < scriptSegments.length) {
                try {
                  recognition.start();
                } catch (e) {}
              }
            }, 1000);
          }
        };
      }

      function startVoiceControl() {
        if (!recognition) initSpeechRecognition();
        isVoiceMode = true;
        startStopBtn.disabled = true; // è¯­éŸ³æ¨¡å¼ä¸‹ç¦ç”¨æ‰‹åŠ¨å¯åŠ¨æŒ‰é’®
        speedInput.disabled = true;

        modeToggleBtn.innerText = "åˆ‡æ¢åˆ° æ‰‹åŠ¨æ¨¡å¼";
        modeToggleBtn.classList.remove("bg-yellow-600", "hover:bg-yellow-500");
        modeToggleBtn.classList.add("bg-purple-600", "hover:bg-purple-500");

        stopScroll(); // ç¡®ä¿æ‰‹åŠ¨æ»šåŠ¨å·²åœæ­¢
        smoothScrollToActiveSegment(); // å±…ä¸­å½“å‰æ®µè½

        if (currentSegmentIndex < scriptSegments.length) {
          recognition.start();
        } else {
          statusMessage.innerText = "è¯·ç‚¹å‡»é‡ç½®æŒ‰é’®å¼€å§‹æœ—è¯»ã€‚";
        }
      }

      function stopVoiceControl() {
        isVoiceMode = false;
        startStopBtn.disabled = scriptSegments.length === 0;
        speedInput.disabled = false;

        modeToggleBtn.innerText = "åˆ‡æ¢åˆ° è¯­éŸ³æ¨¡å¼";
        modeToggleBtn.classList.remove("bg-purple-600", "hover:bg-purple-500");
        modeToggleBtn.classList.add("bg-yellow-600", "hover:bg-yellow-500");

        recognitionHint.classList.remove("visible");
        statusMessage.innerText = "å·²åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";

        if (recognition) {
          recognition.stop();
        }
      }

      /**
       * æ£€æŸ¥è¯†åˆ«ç»“æœå¹¶æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªæ®µè½
       * @param {string} transcript è¯†åˆ«çš„æ–‡æœ¬
       */
      function checkAndAdvance(transcript) {
        if (!isVoiceMode || currentSegmentIndex >= scriptSegments.length)
          return;

        const currentSegment = scriptSegments[currentSegmentIndex];
        const currentWords = currentSegment
          .replace(/[ï¼Œã€‚ï¼ï¼Ÿ]/g, "")
          .slice(0, 10); // å–å‰10ä¸ªå­—ä½œä¸ºåŒ¹é…å…³é”®è¯

        // ç®€å•çš„æ™ºèƒ½åŒ¹é…ï¼šå¦‚æœè¯†åˆ«çš„æ–‡æœ¬åŒ…å«äº†å½“å‰æ®µè½çš„å‰å‡ ä¸ªå…³é”®è¯ï¼Œåˆ™è®¤ä¸ºæœ—è¯»å®Œæˆ
        if (
          transcript.includes(currentWords.slice(0, 5)) ||
          transcript.length > currentWords.length * 0.8
        ) {
          currentSegmentIndex++;
          updateActiveSegment();
          smoothScrollToActiveSegment();

          if (currentSegmentIndex < scriptSegments.length) {
            // ç»§ç»­ç›‘å¬ä¸‹ä¸€ä¸ªæ®µè½
            setTimeout(() => {
              if (isVoiceMode) recognition.start();
            }, 500); // å»¶è¿Ÿ0.5ç§’å¯åŠ¨ï¼Œé¿å…è¯†åˆ«åˆ°æ»šåŠ¨éŸ³æ•ˆ
          } else {
            // è„šæœ¬æœ—è¯»å®Œæ¯•
            stopVoiceControl();
            statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";
          }
        } else {
          // æœªåŒ¹é…ï¼Œç»§ç»­ç›‘å¬
          setTimeout(() => {
            if (isVoiceMode) recognition.start();
          }, 500);
        }
      }

      /**
       * NEW: åˆ‡æ¢é•œåƒçŠ¶æ€
       */
      function toggleMirroring() {
        isMirrored = !isMirrored;
        const segments = document.querySelectorAll(".script-segment");

        if (isMirrored) {
          // 1. ç¿»è½¬å†…å®¹å®¹å™¨ (Wrapper)
          display.style.transform = "scaleX(-1)";
          // 2. ç¿»è½¬å†…éƒ¨æ–‡æœ¬ (Segments) ä½¿å…¶å¯è¯»
          segments.forEach((el) => {
            el.style.transform = "scaleX(-1)";
          });
          mirrorToggleBtn.innerText = "å…³é—­é•œåƒ";
          mirrorToggleBtn.classList.remove("bg-gray-600", "hover:bg-gray-500");
          mirrorToggleBtn.classList.add("bg-blue-600", "hover:bg-blue-500");
        } else {
          // 1. æ¢å¤å†…å®¹å®¹å™¨
          display.style.transform = "none";
          // 2. æ¢å¤å†…éƒ¨æ–‡æœ¬
          segments.forEach((el) => {
            el.style.transform = "none";
          });
          mirrorToggleBtn.innerText = "å¼€å¯é•œåƒ";
          mirrorToggleBtn.classList.remove("bg-blue-600", "hover:bg-blue-500");
          mirrorToggleBtn.classList.add("bg-gray-600", "hover:bg-gray-500");
        }
      }

      // --- äº‹ä»¶ç›‘å¬ ---

      // æ¨¡å¼åˆ‡æ¢
      modeToggleBtn.addEventListener("click", () => {
        if (isVoiceMode) {
          stopVoiceControl();
        } else {
          startVoiceControl();
        }
      });

      // æ‰‹åŠ¨å¯åŠ¨/åœæ­¢
      startStopBtn.addEventListener("click", () => {
        if (isVoiceMode) return;
        isScrolling ? stopScroll() : startScroll();
      });

      // NEW: é•œåƒåˆ‡æ¢
      mirrorToggleBtn.addEventListener("click", toggleMirroring);

      // é‡ç½®æŒ‰é’®
      resetBtn.addEventListener("click", () => {
        stopScroll();
        if (isVoiceMode) stopVoiceControl();
        resetPosition();
      });

      function resetPosition() {
        currentSegmentIndex = 0;
        display.scrollTop = 0; // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œè®©ç¬¬ä¸€ä¸ªæ®µè½å¯è§
        updateActiveSegment();
        if (isVoiceMode && scriptSegments.length > 0) {
          startVoiceControl(); // å¦‚æœåœ¨è¯­éŸ³æ¨¡å¼ä¸‹é‡ç½®ï¼Œåˆ™é‡æ–°å¯åŠ¨ç›‘å¬
        }
      }

      // è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“è„šæœ¬
      input.addEventListener("input", () => {
        renderScript();
        stopScroll(); // ç¡®ä¿ä¿®æ”¹è„šæœ¬æ—¶åœæ­¢æ»šåŠ¨
        if (isVoiceMode) stopVoiceControl(); // ç¡®ä¿ä¿®æ”¹è„šæœ¬æ—¶åœæ­¢è¯­éŸ³æ¨¡å¼
      });

      // é€Ÿåº¦å˜åŒ–
      speedInput.addEventListener("input", () => {
        speedValue.innerText = speedInput.value;
        if (isScrolling) {
          stopScroll();
          startScroll(); // ç«‹å³åº”ç”¨æ–°é€Ÿåº¦
        }
      });

      // å­—ä½“å˜åŒ–
      fontInput.addEventListener("input", () => {
        fontValue.innerText = `${fontInput.value}px`;
        document.querySelectorAll(".script-segment").forEach((el) => {
          el.style.fontSize = `${fontInput.value}px`;
          // NEW: ç¡®ä¿å­—ä½“å¤§å°å˜åŒ–åï¼Œé•œåƒæ ·å¼ä¿æŒ
          if (isMirrored) el.style.transform = "scaleX(-1)";
        });
        updateActiveSegment(); // é‡æ–°å±…ä¸­ï¼Œé˜²æ­¢å­—ä½“å˜åŒ–å¯¼è‡´ä½ç½®åç§»
      });

      // æ–‡æœ¬è¾¹è·å˜åŒ– (Horizontal Padding)
      paddingInput.addEventListener("input", () => {
        const value = `${paddingInput.value}px`;
        paddingValue.innerText = value;
        // åº”ç”¨ padding åˆ°å†…å®¹ wrapper
        display.style.paddingLeft = value;
        display.style.paddingRight = value;
      });

      // æ®µè½é—´è·å˜åŒ– (Vertical Margin)
      paragraphInput.addEventListener("input", () => {
        const value = `${paragraphInput.value}px`;
        paragraphValue.innerText = value;
        // åº”ç”¨ margin-bottom åˆ°æ‰€æœ‰è„šæœ¬æ®µè½
        document.querySelectorAll(".script-segment").forEach((el) => {
          el.style.marginBottom = value;
        });
      });

      // è¡Œé«˜å˜åŒ– (Line Height)
      lineHeightInput.addEventListener("input", () => {
        const value = lineHeightInput.value;
        lineHeightValue.innerText = value;
        // åº”ç”¨ line-height åˆ°æ‰€æœ‰è„šæœ¬æ®µè½
        document.querySelectorAll(".script-segment").forEach((el) => {
          el.style.lineHeight = value;
        });
      });

      // --- åˆå§‹åŒ– ---

      window.onload = function () {
        // 1. åˆå§‹åŒ–è„šæœ¬
        renderScript();

        // 2. æ£€æŸ¥è¯­éŸ³API
        checkSpeechApi();

        // 3. åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¯¹è±¡ (ä½†æš‚æ—¶ä¸å¯åŠ¨)
        initSpeechRecognition();

        // 4. åˆå§‹åŒ–UIçŠ¶æ€
        startStopBtn.disabled = scriptSegments.length === 0;

        // 5. åº”ç”¨åˆå§‹æ–‡æœ¬è¾¹è·
        display.style.paddingLeft = `${paddingInput.value}px`;
        display.style.paddingRight = `${paddingInput.value}px`;
      };
    </script>
  </body>
</html>
