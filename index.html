<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIæ™ºèƒ½æè¯å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* 1. ç¡®ä¿ HTML å’Œ BODY å æ®å…¨éƒ¨è§†å£é«˜åº¦ */
      html,
      body {
        height: 100%;
        margin: 0;
      }

      /* 2. BODY ä½¿ç”¨ Flexbox å‚ç›´å¸ƒå±€ */
      body {
        font-family: "Inter", sans-serif;
        background-color: #1f2937; /* Gray-800 */
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* 3. å®¹å™¨è®¾ç½®ï¼šå æ®å…¨éƒ¨é«˜åº¦ */
      .main-container {
        flex-grow: 1; /* å æ® Body å‰©ä½™é«˜åº¦ */
        display: flex;
        flex-direction: column;
        padding: 1rem;
        overflow: hidden;
        min-height: 0; /* å…³é”®ä¿®å¤ 1: ç¡®ä¿åŒ…å«æ»šåŠ¨å†…å®¹çš„ Flex å®¹å™¨ä¸ä¼šå´©æºƒ */
      }

      /* 4. æè¯å™¨æ˜¾ç¤ºåŒºåŸŸï¼šå æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
      #teleprompter-display {
        position: relative;
        flex-grow: 1; /* å æ® main-container å‰©ä½™é«˜åº¦ */
        overflow: hidden;
        min-height: 0; /* å…³é”®ä¿®å¤ 2: ç¡®ä¿æ»šåŠ¨åŒºåŸŸçš„çˆ¶å…ƒç´ æ­£ç¡®è®¡ç®—å…¶é«˜åº¦ */
      }

      /* è„šæœ¬å†…å®¹å®¹å™¨ï¼šå†…éƒ¨è´Ÿè´£æ»šåŠ¨ */
      #script-content-wrapper {
        width: 100%;
        max-width: 900px;
        height: 100%; /* 100% of #teleprompter-display's calculated height */
        overflow-y: scroll;
        scroll-behavior: smooth;
        padding-top: 50vh;
        padding-bottom: 50vh;
        transition: transform 0.3s ease-out;
        -webkit-overflow-scrolling: touch;
        margin-left: auto;
        margin-right: auto;
      }

      /* === å…¨å±æ¨¡å¼æ ·å¼ä¿æŒä¸å˜ï¼Œä½†æ›´å¥å£® === */
      .is-fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 50;
        border-radius: 0 !important;
        padding: 0 !important;
      }

      .is-fullscreen #script-content-wrapper {
        height: 100vh !important;
      }

      /* å®šä½å±…ä¸­çº¿ */
      #center-line {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        border-top: 2px dashed #fcd34d; /* Amber-300 */
        z-index: 10;
      }

      .script-segment {
        transition: color 0.3s, transform 0.3s, opacity 0.3s;
        text-align: center;
      }
      .active-segment {
        color: #ffeb3b !important; /* Brighter Yellow for better contrast */
        transform: scale(1.05);
        font-weight: 700 !important;
      }
      .recognition-hint {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 50;
        padding: 0.5rem 1rem;
        background: rgba(251, 191, 36, 0.95);
        color: #1f2937;
        border-radius: 9999px;
        font-weight: 600;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      .recognition-hint.visible {
        opacity: 1;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#fcd34d",
              secondary: "#374151",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-900 text-gray-100">
    <!-- ä¸»å®¹å™¨ï¼šä½¿ç”¨ flex-grow å æ® BODY çš„å…¨éƒ¨é«˜åº¦ -->
    <div class="main-container mx-auto max-w-7xl">
      <!-- æ ‡é¢˜åŒ…è£¹å±‚ï¼Œç”¨äºå…¨å±æ—¶éšè— -->
      <div id="header-wrapper" class="flex-shrink-0">
        <h1 class="text-3xl font-bold text-center mb-4 text-primary">
          AIæ™ºèƒ½æè¯å™¨ ğŸ™ï¸
        </h1>
      </div>

      <!-- çŠ¶æ€å’Œæç¤ºä¿¡æ¯ (ä¿æŒåœ¨ä¸»ç•Œé¢å¯è§) -->
      <div
        id="status-message"
        class="text-center p-2 rounded-lg font-medium h-6 mb-2 text-red-400 flex-shrink-0"
      >
        <!-- çŠ¶æ€/é”™è¯¯ä¿¡æ¯ -->
      </div>

      <!-- æè¯å™¨æ˜¾ç¤ºåŒº (Flex-Grow: 1 å æ®å‰©ä½™ç©ºé—´) -->
      <div
        id="teleprompter-display"
        class="relative bg-gray-900 rounded-xl shadow-2xl border border-gray-700"
      >
        <div id="center-line"></div>
        <!-- è„šæœ¬å†…å®¹å®¹å™¨ï¼šè´Ÿè´£æ»šåŠ¨ (æ–‡æœ¬é¢œè‰²ä¸ºç™½è‰²) -->
        <div id="script-content-wrapper" class="text-white">
          <!-- è„šæœ¬å†…å®¹å°†åœ¨æ­¤å¤„æ’å…¥ -->
        </div>
        <div id="recognition-hint" class="recognition-hint">
          æ­£åœ¨å¬... è¯·è¯´å½“å‰æ®µè½
        </div>

        <!-- å…¨å±æ¨¡å¼ä¸‹çš„ä¸­å¿ƒæ§åˆ¶å›¾æ ‡ (Play/Pause) -->
        <div
          id="fs-overlay-controls"
          class="hidden absolute inset-0 z-50 justify-center items-center pointer-events-none"
        >
          <div
            class="p-4 rounded-full bg-gray-900/60 text-white shadow-2xl transition-opacity duration-300"
          >
            <!-- Pause Icon -->
            <svg
              id="fs-pause-icon"
              class="w-16 h-16 sm:w-20 sm:h-20"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
            <!-- Play Icon -->
            <svg
              id="fs-play-icon"
              class="w-16 h-16 sm:w-20 sm:h-20 hidden"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path d="M8 5v14l11-7z" />
            </svg>
          </div>
        </div>

        <!-- æ¨å‡ºå…¨å±æŒ‰é’® (å›ºå®šåœ¨å³ä¸Šè§’) -->
        <button
          id="exit-fs-btn"
          class="hidden absolute top-4 right-4 z-50 p-2 rounded-full bg-gray-700/70 text-white hover:bg-gray-600/90 transition-opacity pointer-events-auto shadow-lg"
        >
          <!-- X Icon -->
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- å¿«é€Ÿæ“ä½œæ  (Flex-Shrink: 0 ä¸ä¼šç¼©å°) -->
      <div
        id="primary-controls"
        class="flex-shrink-0 mt-4 bg-gray-800 p-4 rounded-xl shadow-lg"
      >
        <div class="flex flex-wrap justify-center items-center gap-4">
          <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
          <button
            id="mode-toggle-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-yellow-600 hover:bg-yellow-500 text-gray-900 shadow-md"
          >
            åˆ‡æ¢åˆ° è¯­éŸ³æ¨¡å¼
          </button>

          <!-- å¯åŠ¨/åœæ­¢æŒ‰é’® -->
          <button
            id="start-stop-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-green-600 hover:bg-green-500 text-white shadow-md"
            disabled
          >
            å¯åŠ¨æ»šåŠ¨
          </button>

          <!-- é‡ç½®æŒ‰é’® -->
          <button
            id="reset-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-red-600 hover:bg-red-500 text-white shadow-md"
          >
            é‡ç½®ä½ç½®
          </button>

          <!-- å…¨å±æŒ‰é’® -->
          <button
            id="fullscreen-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-blue-600 hover:bg-blue-500 text-white shadow-md"
          >
            å…¨å±æ˜¾ç¤º
          </button>

          <!-- é•œåƒåŠŸèƒ½æŒ‰é’® -->
          <button
            id="mirror-toggle-btn"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-gray-600 hover:bg-gray-500 text-white shadow-md"
          >
            å¼€å¯é•œåƒ
          </button>

          <!-- NEW Settings Button to open modal -->
          <button
            id="settings-button"
            class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-gray-700 hover:bg-gray-600 text-white shadow-md"
          >
            è®¾ç½® & è„šæœ¬
          </button>
        </div>
      </div>
    </div>
    <!-- END OF MAIN CONTAINER -->

    <!-- === è®¾ç½®å¼¹çª— (Modal) === -->
    <div
      id="settings-modal"
      class="hidden fixed inset-0 z-[100] bg-black bg-opacity-80 flex justify-center items-center p-4"
      aria-modal="true"
      role="dialog"
    >
      <div
        id="control-panel"
        class="bg-gray-900 border border-gray-700 p-6 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all duration-300"
      >
        <div
          class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3"
        >
          <h2 class="text-2xl font-bold text-primary">æè¯å™¨è®¾ç½®ä¸è„šæœ¬</h2>
          <button
            id="close-modal-btn"
            class="text-gray-400 hover:text-white transition"
          >
            <svg
              class="w-8 h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Control Row 1: æ»šåŠ¨é€Ÿåº¦ã€å­—ä½“å¤§å°ã€æ–‡æœ¬è¾¹è·ã€æ®µè½é—´è·æ§åˆ¶ -->
        <div class="flex flex-wrap justify-start items-center gap-6 mt-4">
          <!-- æ»šåŠ¨é€Ÿåº¦æ§åˆ¶ -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="scroll-speed"
              class="block text-sm font-medium text-gray-300"
              >æ»šåŠ¨é€Ÿåº¦ (<span id="speed-value">2</span>)</label
            >
            <input
              type="range"
              id="scroll-speed"
              min="0.5"
              max="5"
              step="0.5"
              value="2"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- å­—ä½“å¤§å°æ§åˆ¶ -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="font-size"
              class="block text-sm font-medium text-gray-300"
              >å­—ä½“å¤§å° (<span id="font-value">48px</span>)</label
            >
            <input
              type="range"
              id="font-size"
              min="20"
              max="96"
              step="4"
              value="48"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- æ–‡æœ¬è¾¹è·æ§åˆ¶ (Horizontal Padding) -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="text-padding"
              class="block text-sm font-medium text-gray-300"
              >æ–‡æœ¬è¾¹è·(å·¦å³) (<span id="padding-value">20px</span>)</label
            >
            <input
              type="range"
              id="text-padding"
              min="0"
              max="150"
              step="5"
              value="20"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <!-- æ®µè½é—´è·æ§åˆ¶ (Vertical Margin) -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="paragraph-spacing"
              class="block text-sm font-medium text-gray-300"
              >æ®µè½é—´è·(å‚ç›´) (<span id="paragraph-value">20px</span>)</label
            >
            <input
              type="range"
              id="paragraph-spacing"
              min="5"
              max="100"
              step="5"
              value="20"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
        </div>

        <!-- Control Row 2: è¡Œé«˜æ§åˆ¶ -->
        <div
          class="flex flex-wrap justify-start items-center gap-6 mt-6 pt-4 border-t border-gray-700"
        >
          <!-- è¡Œé«˜æ§åˆ¶ (Line Height) -->
          <div class="w-full sm:w-1/2 lg:w-[23%]">
            <label
              for="line-height-control"
              class="block text-sm font-medium text-gray-300"
              >è¡Œé«˜ (è¡Œå†…é—´è·) (<span id="line-height-value">1.5</span>)</label
            >
            <input
              type="range"
              id="line-height-control"
              min="1.0"
              max="2.5"
              step="0.1"
              value="1.5"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
        </div>

        <!-- æ–‡æœ¬è¾“å…¥åŒº, ç‹¬ç«‹ä¸€è¡Œ -->
        <div class="w-full mt-6">
          <label
            for="script-input"
            class="block text-sm font-medium text-gray-300"
            >æ¼”è®²ç¨¿å†…å®¹ (è¯·æŒ‰æ¢è¡Œé”®åˆ†éš”è¡Œ)</label
          >
          <!-- é€‚é…æ¨ªå±å’Œæ¡Œé¢ï¼šé»˜è®¤é«˜ 6rem (h-24)ï¼Œä¸­ç­‰å±å¹•ä»¥ä¸Šé«˜ 9rem (md:h-36) -->
          <textarea
            id="script-input"
            class="w-full h-36 p-2 mt-1 rounded-lg bg-gray-700 text-gray-200 focus:ring-primary focus:border-primary border border-gray-600"
          >
å„ä½è§‚ä¼—å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°ä»Šå¤©çš„åˆ†äº«ä¼šã€‚

ä¿¡æ¯æ—¶ä»£ï¼Œæˆ‘ä»¬å¸¸è¢«æ•°å­—ä¸–ç•Œçš„æ··ä¹±æ‰€å›°æ‰°ã€‚
ä½ æ˜¯ä¸æ˜¯ä¹Ÿå¸¸è¢«ç”µè„‘ã€æ‰‹æœºã€ç½‘ç›˜é‡Œçš„æ–‡ä»¶æå¾—ç„¦å¤´çƒ‚é¢ï¼Ÿ
æ˜æ˜ä¿å­˜è¿‡çš„ä¸œè¥¿ï¼Œååæ€¥ç”¨æ—¶ç¿»éå…¨ç½‘éƒ½æ‰¾ä¸åˆ°ï¼Ÿ

åˆ«æ€¥ï¼Œä»Šå¤©æˆ‘è¦ç»™ä½ åˆ†äº«ä¸€ä¸ªè¶…ç®€å•çš„æ–¹æ³•â€”â€”PARAï¼
åªéœ€è¦4ä¸ªæ–‡ä»¶å¤¹ï¼Œå°±èƒ½è®©ä½ çš„æ•°å­—ç”Ÿæ´»ç¬é—´å˜æ¸…çˆ½ï¼Œæ‰¾ä¸œè¥¿å†ä¹Ÿä¸æŠ“ç‹‚ã€‚

é¡¹ç›®ï¼ˆProjectsï¼‰æ”¾ä½ çœ¼ä¸‹æ­£åœ¨å¿™çš„äº‹ã€‚
é¢†åŸŸï¼ˆAreasï¼‰æ”¾ä½ ç”Ÿæ´»ä¸­éœ€è¦æŒç»­å…³æ³¨çš„å¤§å—é¢†åŸŸã€‚
èµ„æºï¼ˆResourcesï¼‰æ”¾ä½ æ„Ÿå…´è¶£æˆ–æ­£åœ¨å­¦ä¹ çš„çŸ¥è¯†åº“ã€‚
å½’æ¡£ï¼ˆArchivesï¼‰æ”¾è¿‡å»å®Œæˆæˆ–æš‚æ—¶ç”¨ä¸ä¸Šçš„ä¸œè¥¿ã€‚

å¯¹ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ï¼è¿™å››ä¸ªæ–‡ä»¶å¤¹ï¼Œæ¶µç›–äº†ä½ æ•°å­—ç”Ÿæ´»çš„æ‰€æœ‰ä¸œè¥¿ã€‚
å·¥ä½œä»»åŠ¡ã€ä¸ªäººå…´è¶£ï¼ŒPARAéƒ½èƒ½å¸®ä½ åˆ†å¾—æ¸…æ¸…æ¥šæ¥šã€‚
æˆ‘è‡ªå·±è¯•äº†ä»¥åï¼ŒçœŸçš„æœ‰ç§â€œæ•‘å‘½å•Šç»ˆäºæ‰¾åˆ°ç»„ç»‡ç¥å™¨â€çš„æ„Ÿè§‰ï¼
è¯•ä¸€æ¬¡ï¼Œä½ å°±çŸ¥é“æœ‰å¤šçˆ½ï¼
æ„Ÿè°¢å¤§å®¶çš„æ”¶å¬ï¼ŒæœŸå¾…ä¸ä½ ä¸‹æœŸå†è§ï¼peaceï½
                </textarea
          >
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let scrollAnimFrameId = null;
      let isScrolling = false;
      let isVoiceMode = false;
      let isMirrored = false;
      let isFullscreen = false;
      let recognition = null;
      let scriptSegments = [];
      let currentSegmentIndex = 0;

      // DOM å…ƒç´ 
      const headerWrapper = document.getElementById("header-wrapper");
      const display = document.getElementById("script-content-wrapper");
      const input = document.getElementById("script-input");
      const startStopBtn = document.getElementById("start-stop-btn");
      const resetBtn = document.getElementById("reset-btn");
      const speedInput = document.getElementById("scroll-speed");
      const speedValue = document.getElementById("speed-value");
      const fontInput = document.getElementById("font-size");
      const fontValue = document.getElementById("font-value");
      const paddingInput = document.getElementById("text-padding");
      const paddingValue = document.getElementById("padding-value");
      const paragraphInput = document.getElementById("paragraph-spacing");
      const paragraphValue = document.getElementById("paragraph-value");
      const lineHeightInput = document.getElementById("line-height-control");
      const lineHeightValue = document.getElementById("line-height-value");
      const mirrorToggleBtn = document.getElementById("mirror-toggle-btn");
      const fullscreenBtn = document.getElementById("fullscreen-btn");
      const fsOverlayControls = document.getElementById("fs-overlay-controls");
      const fsPauseIcon = document.getElementById("fs-pause-icon");
      const fsPlayIcon = document.getElementById("fs-play-icon");
      const exitFsBtn = document.getElementById("exit-fs-btn");

      // MODAL ELEMENTS
      const settingsButton = document.getElementById("settings-button");
      const settingsModal = document.getElementById("settings-modal");
      const closeModalBtn = document.getElementById("close-modal-btn");

      const statusMessage = document.getElementById("status-message");
      const modeToggleBtn = document.getElementById("mode-toggle-btn");
      const recognitionHint = document.getElementById("recognition-hint");

      // --- è¾…åŠ©å‡½æ•° ---

      /**
       * æ¸²æŸ“è„šæœ¬åˆ°æè¯å™¨æ˜¾ç¤ºåŒº (ç°åœ¨æ˜¯æŒ‰è¡Œåˆ†å‰²)
       */
      function renderScript() {
        const lines = input.value.split("\n");
        scriptSegments = lines;

        display.innerHTML = "";
        const currentParagraphSpacing = paragraphInput.value;
        const currentLineHeight = lineHeightInput.value;
        const lineVPadding = "8px";

        scriptSegments.forEach((segment, index) => {
          const div = document.createElement("div");
          const content = segment.trim() === "" ? "&nbsp;" : segment.trim();

          // æ³¨æ„ï¼šè¿™é‡Œ class é‡Œçš„ text-white æ˜¯ä»çˆ¶çº§ç»§æ‰¿çš„ï¼Œç¡®ä¿å¯è§
          div.className =
            "script-segment text-2xl md:text-3xl lg:text-4xl font-semibold opacity-70 transition-all duration-300";
          div.id = `segment-${index}`;
          div.innerHTML = content;
          div.style.fontSize = `${fontInput.value}px`;
          div.style.lineHeight = currentLineHeight;

          if (segment.trim() === "") {
            div.style.marginBottom = `${currentParagraphSpacing}px`;
            div.style.height = "0";
            div.style.padding = "0";
          } else {
            div.style.paddingTop = lineVPadding;
            div.style.paddingBottom = lineVPadding;
            div.style.marginBottom = "0px";
          }

          if (isMirrored) {
            div.style.transform = "scaleX(-1)";
          }

          display.appendChild(div);
        });

        resetPosition();
        updateActiveSegment();
        updateStartButtonState();
      }

      /**
       * æ£€æŸ¥å†…å®¹æ˜¯å¦å¯æ»šåŠ¨å¹¶æ›´æ–°å¯åŠ¨æŒ‰é’®çŠ¶æ€
       */
      function updateStartButtonState() {
        const hasContent =
          scriptSegments.length > 0 &&
          scriptSegments.some((s) => s.trim() !== "");

        if (!hasContent) {
          startStopBtn.disabled = true;
          statusMessage.innerText = "è„šæœ¬å†…å®¹ä¸ºç©ºï¼Œè¯·åœ¨è®¾ç½®ä¸­è¾“å…¥è„šæœ¬ã€‚";
          return;
        }

        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿DOMå¸ƒå±€å®Œæˆä¸”scrollHeightè®¡ç®—å‡†ç¡®
        setTimeout(() => {
          // æ£€æŸ¥å†…å®¹æ˜¯å¦æº¢å‡ºå®¹å™¨ (è¿™æ˜¯ç§»åŠ¨ç«¯æ»šåŠ¨å¤±è´¥çš„å…³é”®æ£€æŸ¥ç‚¹)
          const isScrollable = display.scrollHeight > display.clientHeight + 10; // å¢åŠ 10pxç¼“å†²
          startStopBtn.disabled = !isScrollable && !isVoiceMode;

          if (!isScrollable && !isVoiceMode) {
            statusMessage.innerText = "âš ï¸ è„šæœ¬å†…å®¹å¤ªçŸ­ï¼Œæ— æ³•å¯åŠ¨æ»šåŠ¨ã€‚";
          } else {
            // åªæœ‰åœ¨éè¯­éŸ³æ¨¡å¼ä¸‹ä¸”æ— æ»šåŠ¨é—®é¢˜æ—¶æ‰æ¸…ç©ºçŠ¶æ€ï¼Œä»¥å…è¦†ç›–è¯­éŸ³æç¤º
            if (!isVoiceMode) {
              statusMessage.innerText = "";
            }
          }
        }, 100); // 100ms å»¶è¿Ÿç¡®ä¿å¸ƒå±€åœ¨ç§»åŠ¨ç«¯ç¨³å®š
      }

      /**
       * æ›´æ–°å½“å‰æ´»åŠ¨çš„æ®µè½/è¡Œæ ·å¼
       */
      function updateActiveSegment() {
        document.querySelectorAll(".script-segment").forEach((el, index) => {
          el.classList.remove("active-segment", "opacity-100");

          if (index === currentSegmentIndex) {
            el.classList.add("active-segment", "opacity-100");
            el.classList.remove("opacity-70", "opacity-30");
          } else if (index < currentSegmentIndex) {
            el.classList.add("opacity-30");
            el.classList.remove("opacity-70");
          } else {
            el.classList.add("opacity-70");
            el.classList.remove("opacity-30");
          }
        });
      }

      /**
       * æ ¹æ®å½“å‰æ»šåŠ¨ä½ç½®æ›´æ–°æ´»åŠ¨æ®µè½
       */
      function updateSegmentByScrollPosition() {
        // åªæœ‰åœ¨æ‰‹åŠ¨æ»šåŠ¨æˆ–é™æ­¢æ—¶ï¼Œæ‰æ ¹æ®ä½ç½®æ›´æ–°æ´»åŠ¨æ®µè½
        if (isScrolling || isVoiceMode) return;

        const segments = document.querySelectorAll(".script-segment");
        if (segments.length === 0) return;

        const scrollWrapperRect = display.getBoundingClientRect();
        const centerOffset =
          scrollWrapperRect.top + scrollWrapperRect.height / 2;

        let bestIndex = currentSegmentIndex;
        let minDistance = Infinity;

        segments.forEach((el, index) => {
          if (scriptSegments[index].trim() === "") return;

          const rect = el.getBoundingClientRect();
          const elCenter = rect.top + rect.height / 2;

          const distance = Math.abs(elCenter - centerOffset);

          if (distance < minDistance) {
            minDistance = distance;
            bestIndex = index;
          }
        });

        if (bestIndex !== currentSegmentIndex) {
          currentSegmentIndex = bestIndex;
          updateActiveSegment();
        }
      }

      /**
       * å¹³æ»‘æ»šåŠ¨åˆ°å½“å‰æ´»åŠ¨æ®µè½çš„ä¸­å¤®
       */
      function smoothScrollToActiveSegment() {
        const activeSegment = document.getElementById(
          `segment-${currentSegmentIndex}`
        );
        if (activeSegment) {
          activeSegment.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }
      }

      /**
       * æ£€æŸ¥ Web Speech API å…¼å®¹æ€§
       */
      function checkSpeechApi() {
        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          statusMessage.innerText =
            "âš ï¸ è­¦å‘Š: æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API (è¯­éŸ³è¯†åˆ«)ã€‚æ™ºèƒ½è¯­éŸ³æ¨¡å¼å°†ä¸å¯ç”¨ã€‚";
          modeToggleBtn.disabled = true;
          return false;
        }
        statusMessage.innerText = "";
        return true;
      }

      // --- Modal Logic ---

      function openSettingsModal() {
        settingsModal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        if (isScrolling) stopScroll();
        // ç¡®ä¿è¾“å…¥æ¡†èšç„¦ï¼Œæ–¹ä¾¿ç¼–è¾‘
        setTimeout(() => input.focus(), 10);
      }

      function closeSettingsModal() {
        settingsModal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
        // ç¡®ä¿å†…å®¹æ›´æ”¹åç«‹å³é‡æ–°æ¸²æŸ“è„šæœ¬
        renderScript();
      }

      /**
       * æ›´æ–°å…¨å±æ¨¡å¼ä¸‹çš„æš‚åœ/æ’­æ”¾å›¾æ ‡
       */
      function updateFullscreenIcons() {
        if (!isFullscreen) return;
        if (isScrolling) {
          fsPauseIcon.classList.remove("hidden");
          fsPlayIcon.classList.add("hidden");
        } else {
          fsPauseIcon.classList.add("hidden");
          fsPlayIcon.classList.remove("hidden");
        }
      }

      // --- æ ¸å¿ƒæ¨¡å¼é€»è¾‘ï¼šæ‰‹åŠ¨æ»šåŠ¨ (ä½¿ç”¨ requestAnimationFrame) ---

      /**
       * æ»šåŠ¨å¾ªç¯ (ä½¿ç”¨ requestAnimationFrame)
       */
      function scrollLoop() {
        if (!isScrolling) return;

        const speed = parseFloat(speedInput.value);

        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾åº•éƒ¨
        if (
          display.scrollTop + display.clientHeight >=
          display.scrollHeight - 5
        ) {
          stopScroll();
          return;
        }

        // åº”ç”¨æ»šåŠ¨
        display.scrollTop += speed;

        // ç»§ç»­ä¸‹ä¸€å¸§çš„å¾ªç¯
        scrollAnimFrameId = requestAnimationFrame(scrollLoop);
      }

      function startScroll() {
        if (isScrolling) return;

        // 1. ç¡®ä¿å†…å®¹å¯æ»šåŠ¨ (å†æ¬¡æ£€æŸ¥)
        if (display.scrollHeight <= display.clientHeight + 10) {
          statusMessage.innerText =
            "âš ï¸ è„šæœ¬å†…å®¹å¤ªçŸ­ï¼Œæ— æ³•å¯åŠ¨æ»šåŠ¨ã€‚è¯·åœ¨è®¾ç½®ä¸­æ·»åŠ æ›´å¤šæ–‡æœ¬ã€‚";
          stopScroll();
          return;
        }

        isScrolling = true;
        startStopBtn.innerText = "æš‚åœæ»šåŠ¨";
        startStopBtn.classList.remove("bg-green-600", "hover:bg-green-500");
        startStopBtn.classList.add("bg-orange-600", "hover:bg-orange-500");

        updateFullscreenIcons();

        // 2. å¯åŠ¨ requestAnimationFrame å¾ªç¯
        scrollLoop();
      }

      function stopScroll() {
        if (!isScrolling) return;
        isScrolling = false;

        // ä½¿ç”¨ cancelAnimationFrame åœæ­¢å¾ªç¯
        if (scrollAnimFrameId) {
          cancelAnimationFrame(scrollAnimFrameId);
          scrollAnimFrameId = null;
        }

        startStopBtn.innerText = "å¯åŠ¨æ»šåŠ¨";
        startStopBtn.classList.remove("bg-orange-600", "hover:bg-orange-500");
        startStopBtn.classList.add("bg-green-600", "hover:bg-green-500");

        updateFullscreenIcons();
      }

      // --- æ ¸å¿ƒæ¨¡å¼é€»è¾‘ï¼šè¯­éŸ³æ™ºèƒ½æ¨è¿› (ä¿æŒä¸å˜) ---

      function initSpeechRecognition() {
        if (!checkSpeechApi()) return;

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "zh-CN";

        recognition.onstart = () => {
          recognitionHint.innerText = "ğŸ™ï¸ æ­£åœ¨å¬... è¯·è¯´å½“å‰è¡Œ";
          recognitionHint.classList.add("visible");
          statusMessage.innerText = "è¯­éŸ³æ¨¡å¼å·²å¯åŠ¨ï¼Œè¯·å¼€å§‹æœ—è¯»ã€‚";
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          console.log("è¯†åˆ«ç»“æœ:", transcript);
          checkAndAdvance(transcript);
        };

        recognition.onend = () => {
          recognitionHint.classList.remove("visible");
          if (isVoiceMode) {
            setTimeout(() => {
              if (isVoiceMode && currentSegmentIndex < scriptSegments.length) {
                try {
                  recognition.start();
                } catch (e) {
                  console.warn(
                    "Recognition already started, ignoring auto-restart."
                  );
                }
              } else if (currentSegmentIndex >= scriptSegments.length) {
                statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼";
              }
            }, 100);
          }
        };

        recognition.onerror = (event) => {
          console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
          statusMessage.innerText = `âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}. è¯·æ£€æŸ¥éº¦å…‹é£æƒé™ã€‚`;
          recognitionHint.classList.remove("visible");
          if (isVoiceMode) {
            setTimeout(() => {
              if (isVoiceMode && currentSegmentIndex < scriptSegments.length) {
                try {
                  recognition.start();
                } catch (e) {}
              }
            }, 1000);
          }
        };
      }

      function startVoiceControl() {
        if (!recognition) initSpeechRecognition();
        isVoiceMode = true;
        startStopBtn.disabled = true;
        speedInput.disabled = true;
        fullscreenBtn.disabled = true;

        modeToggleBtn.innerText = "åˆ‡æ¢åˆ° æ‰‹åŠ¨æ¨¡å¼";
        modeToggleBtn.classList.remove("bg-yellow-600", "hover:bg-yellow-500");
        modeToggleBtn.classList.add("bg-purple-600", "hover:bg-purple-500");

        stopScroll();

        smoothScrollToActiveSegment();

        if (currentSegmentIndex < scriptSegments.length) {
          recognition.start();
        } else {
          statusMessage.innerText = "è¯·ç‚¹å‡»é‡ç½®æŒ‰é’®å¼€å§‹æœ—è¯»ã€‚";
        }
      }

      function stopVoiceControl() {
        isVoiceMode = false;
        updateStartButtonState();
        speedInput.disabled = false;
        fullscreenBtn.disabled = false;

        modeToggleBtn.innerText = "åˆ‡æ¢åˆ° è¯­éŸ³æ¨¡å¼";
        modeToggleBtn.classList.remove("bg-purple-600", "hover:bg-purple-500");
        modeToggleBtn.classList.add("bg-yellow-600", "hover:bg-yellow-500");

        recognitionHint.classList.remove("visible");
        statusMessage.innerText = "å·²åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";

        if (recognition) {
          recognition.stop();
        }
      }

      function checkAndAdvance(transcript) {
        if (!isVoiceMode || currentSegmentIndex >= scriptSegments.length)
          return;

        // è·³è¿‡ç©ºè¡Œ
        while (
          currentSegmentIndex < scriptSegments.length &&
          scriptSegments[currentSegmentIndex].trim() === ""
        ) {
          currentSegmentIndex++;
        }
        if (currentSegmentIndex >= scriptSegments.length) {
          stopVoiceControl();
          statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";
          return;
        }

        const currentLine = scriptSegments[currentSegmentIndex];
        const matchText = currentLine
          .replace(/[ï¼Œã€‚ï¼ï¼Ÿ]/g, "")
          .trim()
          .slice(0, 15);

        const isMatch =
          transcript.includes(matchText.slice(0, 8)) ||
          (transcript.length > matchText.length * 0.5 &&
            transcript.includes(matchText.slice(0, 3)));

        if (isMatch) {
          console.log(
            `Matched line ${currentSegmentIndex + 1}: "${currentLine.slice(
              0,
              10
            )}..."`
          );
          currentSegmentIndex++;
          updateActiveSegment();
          smoothScrollToActiveSegment();

          if (currentSegmentIndex < scriptSegments.length) {
            // ç¡®ä¿ä¸‹ä¸€ä¸ªéç©ºè¡Œè¢«é€‰ä¸­
            while (
              currentSegmentIndex < scriptSegments.length &&
              scriptSegments[currentSegmentIndex].trim() === ""
            ) {
              currentSegmentIndex++;
            }
            setTimeout(() => {
              if (isVoiceMode && currentSegmentIndex < scriptSegments.length)
                recognition.start();
            }, 500);
          } else {
            stopVoiceControl();
            statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";
          }
        } else {
          // æ²¡æœ‰åŒ¹é…åˆ°ï¼Œé‡æ–°å¼€å§‹å¬
          setTimeout(() => {
            if (isVoiceMode) recognition.start();
          }, 500);
        }
      }

      // --- å…¶ä»–äº‹ä»¶å¤„ç† (ä¿æŒä¸å˜) ---

      function toggleMirroring() {
        isMirrored = !isMirrored;
        const segments = document.querySelectorAll(".script-segment");

        if (isMirrored) {
          // Note: Applying mirror transform to the scrollable container
          document.getElementById("teleprompter-display").style.transform =
            "scaleX(-1)";
          segments.forEach((el) => {
            // Apply reverse mirror to content inside
            el.style.transform = "scaleX(-1)";
          });
          mirrorToggleBtn.innerText = "å…³é—­é•œåƒ";
          mirrorToggleBtn.classList.remove("bg-gray-600", "hover:bg-gray-500");
          mirrorToggleBtn.classList.add("bg-blue-600", "hover:bg-blue-500");
        } else {
          document.getElementById("teleprompter-display").style.transform =
            "none";
          segments.forEach((el) => {
            el.style.transform = "none";
          });
          mirrorToggleBtn.innerText = "å¼€å¯é•œåƒ";
          mirrorToggleBtn.classList.remove("bg-blue-600", "hover:bg-blue-500");
          mirrorToggleBtn.classList.add("bg-gray-600", "hover:bg-gray-500");
        }
      }

      function toggleFullscreen() {
        isFullscreen = !isFullscreen;
        const teleprompterDisplay = document.getElementById(
          "teleprompter-display"
        );

        if (isFullscreen) {
          if (isVoiceMode) stopVoiceControl();

          document.body.classList.add("overflow-hidden");
          headerWrapper.classList.add("hidden");
          document.getElementById("primary-controls").classList.add("hidden");
          statusMessage.classList.add("hidden");

          teleprompterDisplay.classList.add("is-fullscreen");

          fsOverlayControls.classList.remove("hidden");
          fsOverlayControls.classList.add("flex");
          exitFsBtn.classList.remove("hidden");

          fullscreenBtn.innerText = "é€€å‡ºå…¨å±";

          updateFullscreenIcons();
          updateStartButtonState();
        } else {
          document.body.classList.remove("overflow-hidden");
          headerWrapper.classList.remove("hidden");
          document
            .getElementById("primary-controls")
            .classList.remove("hidden");
          statusMessage.classList.remove("hidden");

          teleprompterDisplay.classList.remove("is-fullscreen");

          fsOverlayControls.classList.add("hidden");
          fsOverlayControls.classList.remove("flex");
          exitFsBtn.classList.add("hidden");

          fullscreenBtn.innerText = "å…¨å±æ˜¾ç¤º";

          stopScroll();
          updateStartButtonState();
        }
      }

      function handleFullscreenClick() {
        if (isFullscreen && !isVoiceMode) {
          if (isScrolling) {
            stopScroll();
          } else {
            if (!startStopBtn.disabled) {
              startScroll();
            }
          }
        }
      }

      // --- äº‹ä»¶ç›‘å¬å™¨ ---

      settingsButton.addEventListener("click", openSettingsModal);
      closeModalBtn.addEventListener("click", closeSettingsModal);
      settingsModal.addEventListener("click", (e) => {
        // ç‚¹å‡»èƒŒæ™¯å…³é—­ Modal
        if (e.target === settingsModal) {
          closeSettingsModal();
        }
      });

      modeToggleBtn.addEventListener("click", () => {
        if (isVoiceMode) {
          stopVoiceControl();
        } else {
          if (isFullscreen) {
            statusMessage.innerText =
              "âš ï¸ è¯­éŸ³æ¨¡å¼ä¸‹æ— æ³•è¿›å…¥å…¨å±æ»šåŠ¨æ¨¡å¼ã€‚è¯·å…ˆé€€å‡ºå…¨å±ã€‚";
            return;
          }
          startVoiceControl();
        }
      });

      startStopBtn.addEventListener("click", () => {
        if (isVoiceMode) return;
        isScrolling ? stopScroll() : startScroll();
      });

      mirrorToggleBtn.addEventListener("click", toggleMirroring);

      fullscreenBtn.addEventListener("click", () => {
        if (isVoiceMode) {
          statusMessage.innerText =
            "âš ï¸ è¯­éŸ³æ¨¡å¼ä¸‹æ— æ³•è¿›å…¥å…¨å±æ»šåŠ¨æ¨¡å¼ã€‚è¯·å…ˆåˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼ã€‚";
          return;
        }
        toggleFullscreen();
      });

      exitFsBtn.addEventListener("click", toggleFullscreen);

      document
        .getElementById("teleprompter-display")
        .addEventListener("click", handleFullscreenClick);

      display.addEventListener("scroll", updateSegmentByScrollPosition);

      document.addEventListener("keydown", (e) => {
        // é”®ç›˜æ“ä½œï¼šä¸åœ¨è¾“å…¥æ¡†å†…æ—¶å“åº”
        if (
          input === document.activeElement ||
          settingsModal.classList.contains("hidden")
        )
          return;

        if (e.code === "Space" || e.key === "Enter") {
          e.preventDefault();
          if (isVoiceMode) return;

          if (isFullscreen && !startStopBtn.disabled) {
            handleFullscreenClick();
          } else if (!isFullscreen && !startStopBtn.disabled) {
            isScrolling ? stopScroll() : startScroll();
          }
        }

        if (!isVoiceMode) {
          const scrollStep = 40;
          let scrolled = false;

          if (e.key === "ArrowDown") {
            e.preventDefault();
            if (!isScrolling) {
              display.scrollTop += scrollStep;
              scrolled = true;
            }
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            if (!isScrolling) {
              display.scrollTop -= scrollStep;
              scrolled = true;
            }
          }

          if (scrolled) {
            setTimeout(updateSegmentByScrollPosition, 100);
          }
        }
      });

      resetBtn.addEventListener("click", () => {
        stopScroll();
        if (isVoiceMode) stopVoiceControl();
        resetPosition();
      });

      function resetPosition() {
        currentSegmentIndex = 0;
        display.scrollTop = 0;
        updateActiveSegment();
        if (isVoiceMode && scriptSegments.length > 0) {
          startVoiceControl();
        }
      }

      // è„šæœ¬è¾“å…¥å’Œæ»‘å—æ›´æ”¹äº‹ä»¶ï¼šåœ¨å¼¹çª—ä¸­è¿›è¡Œï¼Œä½†ç›‘å¬å™¨ä¿æŒä¸å˜
      input.addEventListener("input", () => {
        // ä»…åœ¨å…³é—­å¼¹çª—æ—¶è°ƒç”¨ renderScriptï¼Œä»¥é¿å…è¾“å…¥æ—¶é¢‘ç¹é‡ç»˜
        // ä½†è¿™é‡Œä¸ºäº†å³æ—¶åé¦ˆï¼Œä¿ç•™ç›´æ¥è°ƒç”¨
        renderScript();
        stopScroll();
        if (isVoiceMode) stopVoiceControl();
      });

      speedInput.addEventListener("input", () => {
        speedValue.innerText = speedInput.value;
      });

      fontInput.addEventListener("input", () => {
        fontValue.innerText = `${fontInput.value}px`;
        document.querySelectorAll(".script-segment").forEach((el) => {
          el.style.fontSize = `${fontInput.value}px`;
          if (isMirrored) el.style.transform = "scaleX(-1)";
        });
        updateSegmentByScrollPosition();
      });

      paddingInput.addEventListener("input", () => {
        const value = `${paddingInput.value}px`;
        paddingValue.innerText = value;
        // Apply padding to the scrollable display element
        document.getElementById("teleprompter-display").style.paddingLeft =
          value;
        document.getElementById("teleprompter-display").style.paddingRight =
          value;
        updateSegmentByScrollPosition();
      });

      paragraphInput.addEventListener("input", () => {
        const value = `${paragraphInput.value}px`;
        paragraphValue.innerText = value;
        document.querySelectorAll(".script-segment").forEach((el, index) => {
          if (scriptSegments[index].trim() === "") {
            el.style.marginBottom = value;
          }
        });
        updateSegmentByScrollPosition();
      });

      lineHeightInput.addEventListener("input", () => {
        const value = lineHeightInput.value;
        lineHeightValue.innerText = value;
        document.querySelectorAll(".script-segment").forEach((el) => {
          el.style.lineHeight = value;
        });
        updateSegmentByScrollPosition();
      });

      window.addEventListener("resize", () => {
        setTimeout(updateStartButtonState, 200);
        if (isScrolling) {
          stopScroll();
        }
        smoothScrollToActiveSegment();
      });

      // --- åˆå§‹åŒ– ---

      window.onload = function () {
        // 1. è®¾ç½®åˆå§‹å†…è¾¹è· (è¿™é‡Œéœ€è¦åº”ç”¨åˆ°å¤–å±‚å®¹å™¨)
        document.getElementById(
          "teleprompter-display"
        ).style.paddingLeft = `${paddingInput.value}px`;
        document.getElementById(
          "teleprompter-display"
        ).style.paddingRight = `${paddingInput.value}px`;

        // 2. æ¸²æŸ“è„šæœ¬å†…å®¹
        renderScript();

        // 3. æ£€æŸ¥è¯­éŸ³APIå¹¶åˆå§‹åŒ–
        checkSpeechApi();
        initSpeechRecognition();

        // 4. é‡ç½®æ»šåŠ¨ä½ç½®åˆ°é¡¶éƒ¨ (åŒæ—¶ä¼šè§¦å‘ updateActiveSegment)
        resetPosition();

        // 5. å†æ¬¡æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateStartButtonState();
      };
    </script>
  </body>
</html>
