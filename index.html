<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIæ™ºèƒ½æè¯å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* å¼ºåˆ¶ä½¿ç”¨æ·±è‰²èƒŒæ™¯ï¼Œæé«˜é˜…è¯»å¯¹æ¯”åº¦ */
      body {
        font-family: "Inter", sans-serif;
        background-color: #1f2937; /* Gray-800 */
      }
      /* æè¯å™¨å†…å®¹åŒºåŸŸï¼Œå®ç°å…¨å±å±…ä¸­é˜…è¯»æ•ˆæœ */
      #teleprompter-display {
        position: relative;
        /* é»˜è®¤é«˜åº¦ï¼šå‡å»æ§åˆ¶é¢æ¿çš„é«˜åº¦ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†ç«–å±/æ¡Œé¢ */
        height: calc(100vh - 280px);
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 1rem;
      }

      /* === å“åº”å¼ä¼˜åŒ–ï¼šé’ˆå¯¹æ¨ªå±æˆ–å°å±å¹• === */
      @media (max-width: 1024px) and (orientation: landscape) {
        /* åœ¨æ‰‹æœºæ¨ªå±æ¨¡å¼ä¸‹ï¼Œæ§åˆ¶é¢æ¿åœ¨å±å¹•ä¸Šå æ®çš„ç›¸å¯¹ç©ºé—´å˜å°ï¼Œ
               å› æ­¤æè¯å™¨æ˜¾ç¤ºåŒºå¯ä»¥å æ®æ›´å¤šçš„å‚ç›´é«˜åº¦ */
        #teleprompter-display {
          height: calc(100vh - 150px);
        }
        /* éšè—ä¸»ä½“å†…å®¹çš„å®¹å™¨ï¼Œé¿å…åœ¨å…¨å±æ—¶æ»šåŠ¨ */
        .overflow-hidden {
          overflow: hidden;
        }
      }
      /* ================================== */

      /* === NEW: å…¨å±æ¨¡å¼æ ·å¼ === */
      .is-fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 50; /* Needs to be high enough to cover everything */
        border-radius: 0 !important;
        border: none !important;
        padding: 0 !important; /* Remove container padding */
      }

      .is-fullscreen #script-content-wrapper {
        /* ç¡®ä¿å†…å®¹åœ¨å…¨å±æ—¶èƒ½ä½¿ç”¨å…¨é«˜ */
        height: 100vh !important;
      }

      /* å®šåˆ¶æ»šåŠ¨æ¡å¤–è§‚ */
      .scrolling-content::-webkit-scrollbar {
        width: 8px;
      }
      .scrolling-content::-webkit-scrollbar-thumb {
        background-color: #4b5563; /* Gray-600 */
        border-radius: 4px;
      }
      .scrolling-content::-webkit-scrollbar-track {
        background: #374151; /* Gray-700 */
      }

      /* ç”¨äºå®šä½å±…ä¸­çº¿ */
      #center-line {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        border-top: 2px dashed #fcd34d; /* Amber-300 */
        z-index: 10;
      }
      /* å†…å®¹å®¹å™¨ï¼Œå…è®¸å†…éƒ¨å†…å®¹å‚ç›´å±…ä¸­å®šä½ */
      #script-content-wrapper {
        width: 100%;
        max-width: 900px;
        height: 100%;
        overflow-y: scroll;
        scroll-behavior: smooth;
        padding-top: 50vh; /* ç¡®ä¿ç¬¬ä¸€è¡Œå†…å®¹å¯ä»¥æ»šåŠ¨åˆ°ä¸­é—´ */
        padding-bottom: 50vh; /* ç¡®ä¿æœ€åä¸€è¡Œå†…å®¹å¯ä»¥æ»šåŠ¨åˆ°ä¸­é—´ */
        /* åˆå§‹æ°´å¹³è¾¹è·å°†åœ¨JSä¸­è®¾ç½® */
        transition: transform 0.3s ease-out; /* å¹³æ»‘è¿‡æ¸¡é•œåƒæ•ˆæœ */
      }
      /* è„šæœ¬æ®µè½æ ·å¼ - ç°åœ¨ç”¨äºæ¯ä¸€è¡Œ */
      .script-segment {
        transition: color 0.3s, transform 0.3s, opacity 0.3s;
        text-align: center;
      }
      /* æ¿€æ´»æ®µè½/è¡Œæ ·å¼ */
      .active-segment {
        color: #fcd34d !important; /* Amber-300 */
        transform: scale(1.05);
        font-weight: 700 !important;
      }
      /* è¯†åˆ«æç¤ºæ ·å¼ */
      .recognition-hint {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 50;
        padding: 0.5rem 1rem;
        background: rgba(251, 191, 36, 0.95); /* Amber-400 */
        color: #1f2937;
        border-radius: 9999px;
        font-weight: 600;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      .recognition-hint.visible {
        opacity: 1;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#fcd34d",
              secondary: "#374151",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl">
      <!-- NEW: æ ‡é¢˜åŒ…è£¹å±‚ï¼Œç”¨äºå…¨å±æ—¶éšè— -->
      <div id="header-wrapper">
        <h1 class="text-3xl font-bold text-center mb-6 text-primary">
          AIæ™ºèƒ½æè¯å™¨ ğŸ™ï¸
        </h1>
      </div>

      <!-- æè¯å™¨æ˜¾ç¤ºåŒº -->
      <div
        id="teleprompter-display"
        class="relative bg-gray-900 rounded-xl shadow-2xl border border-gray-700"
      >
        <div id="center-line"></div>
        <div id="script-content-wrapper" class="text-gray-300">
          <!-- è„šæœ¬å†…å®¹å°†åœ¨æ­¤å¤„æ’å…¥ -->
        </div>
        <div id="recognition-hint" class="recognition-hint">
          æ­£åœ¨å¬... è¯·è¯´å½“å‰æ®µè½
        </div>

        <!-- NEW: å…¨å±æ¨¡å¼ä¸‹çš„ä¸­å¿ƒæ§åˆ¶å›¾æ ‡ (Play/Pause) -->
        <div
          id="fs-overlay-controls"
          class="hidden absolute inset-0 z-50 justify-center items-center pointer-events-none"
        >
          <div
            class="p-4 rounded-full bg-gray-900/60 text-white shadow-2xl transition-opacity duration-300"
          >
            <!-- Pause Icon (Default: Visible when scrolling) -->
            <svg
              id="fs-pause-icon"
              class="w-16 h-16 sm:w-20 sm:h-20"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
            <!-- Play Icon (Default: Hidden when scrolling) -->
            <svg
              id="fs-play-icon"
              class="w-16 h-16 sm:w-20 sm:h-20 hidden"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path d="M8 5v14l11-7z" />
            </svg>
          </div>
        </div>

        <!-- NEW: æ¨å‡ºå…¨å±æŒ‰é’® (å›ºå®šåœ¨å³ä¸Šè§’) -->
        <button
          id="exit-fs-btn"
          class="hidden absolute top-4 right-4 z-50 p-2 rounded-full bg-gray-700/70 text-white hover:bg-gray-600/90 transition-opacity pointer-events-auto shadow-lg"
        >
          <!-- X Icon -->
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- NEW: åº•éƒ¨æ§åˆ¶å’ŒçŠ¶æ€ä¿¡æ¯åŒ…è£¹å±‚ï¼Œç”¨äºå…¨å±æ—¶éšè— -->
      <div id="bottom-controls-wrapper">
        <!-- çŠ¶æ€å’Œæç¤ºä¿¡æ¯ -->
        <div
          id="status-message"
          class="text-center mt-4 p-2 rounded-lg font-medium text-red-400"
        >
          <!-- çŠ¶æ€/é”™è¯¯ä¿¡æ¯ -->
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div
          id="control-panel"
          class="bg-gray-800 p-4 rounded-xl mt-6 shadow-lg"
        >
          <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
            <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <button
              id="mode-toggle-btn"
              class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-yellow-600 hover:bg-yellow-500 text-gray-900 shadow-md"
            >
              åˆ‡æ¢åˆ° è¯­éŸ³æ¨¡å¼
            </button>

            <!-- NEW: å…¨å±æŒ‰é’® -->
            <button
              id="fullscreen-btn"
              class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-blue-600 hover:bg-blue-500 text-white shadow-md"
            >
              å…¨å±æ˜¾ç¤º
            </button>

            <!-- NEW: é•œåƒåŠŸèƒ½æŒ‰é’® -->
            <button
              id="mirror-toggle-btn"
              class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-gray-600 hover:bg-gray-500 text-white shadow-md"
            >
              å¼€å¯é•œåƒ
            </button>

            <!-- å¯åŠ¨/åœæ­¢æŒ‰é’® -->
            <button
              id="start-stop-btn"
              class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-green-600 hover:bg-green-500 text-white shadow-md"
              disabled
            >
              å¯åŠ¨æ»šåŠ¨
            </button>

            <!-- é‡ç½®æŒ‰é’® -->
            <button
              id="reset-btn"
              class="flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition duration-200 bg-red-600 hover:bg-red-500 text-white shadow-md"
            >
              é‡ç½®ä½ç½®
            </button>
          </div>

          <!-- Control Row 1: æ»šåŠ¨é€Ÿåº¦ã€å­—ä½“å¤§å°ã€æ–‡æœ¬è¾¹è·ã€æ®µè½é—´è·æ§åˆ¶ -->
          <div class="flex flex-wrap justify-start items-center gap-6 mt-4">
            <!-- æ»šåŠ¨é€Ÿåº¦æ§åˆ¶ -->
            <div class="w-full sm:w-1/2 lg:w-[23%]">
              <label
                for="scroll-speed"
                class="block text-sm font-medium text-gray-300"
                >æ»šåŠ¨é€Ÿåº¦ (<span id="speed-value">2</span>)</label
              >
              <input
                type="range"
                id="scroll-speed"
                min="0.5"
                max="5"
                step="0.5"
                value="2"
                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            <!-- å­—ä½“å¤§å°æ§åˆ¶ -->
            <div class="w-full sm:w-1/2 lg:w-[23%]">
              <label
                for="font-size"
                class="block text-sm font-medium text-gray-300"
                >å­—ä½“å¤§å° (<span id="font-value">48px</span>)</label
              >
              <input
                type="range"
                id="font-size"
                min="20"
                max="96"
                step="4"
                value="48"
                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            <!-- æ–‡æœ¬è¾¹è·æ§åˆ¶ (Horizontal Padding) -->
            <div class="w-full sm:w-1/2 lg:w-[23%]">
              <label
                for="text-padding"
                class="block text-sm font-medium text-gray-300"
                >æ–‡æœ¬è¾¹è·(å·¦å³) (<span id="padding-value">20px</span>)</label
              >
              <input
                type="range"
                id="text-padding"
                min="0"
                max="150"
                step="5"
                value="20"
                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            <!-- æ®µè½é—´è·æ§åˆ¶ (Vertical Margin) -->
            <div class="w-full sm:w-1/2 lg:w-[23%]">
              <label
                for="paragraph-spacing"
                class="block text-sm font-medium text-gray-300"
                >æ®µè½é—´è·(å‚ç›´) (<span id="paragraph-value">20px</span>)</label
              >
              <input
                type="range"
                id="paragraph-spacing"
                min="5"
                max="100"
                step="5"
                value="20"
                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>
          </div>

          <!-- Control Row 2: è¡Œé«˜æ§åˆ¶ -->
          <div
            class="flex flex-wrap justify-start items-center gap-6 mt-6 pt-4 border-t border-gray-700"
          >
            <!-- è¡Œé«˜æ§åˆ¶ (Line Height) -->
            <div class="w-full sm:w-1/2 lg:w-[23%]">
              <label
                for="line-height-control"
                class="block text-sm font-medium text-gray-300"
                >è¡Œé«˜ (è¡Œå†…é—´è·) (<span id="line-height-value">1.5</span
                >)</label
              >
              <input
                type="range"
                id="line-height-control"
                min="1.0"
                max="2.5"
                step="0.1"
                value="1.5"
                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
              />
            </div>
          </div>

          <!-- æ–‡æœ¬è¾“å…¥åŒº, ç‹¬ç«‹ä¸€è¡Œ -->
          <div class="w-full mt-6">
            <label
              for="script-input"
              class="block text-sm font-medium text-gray-300"
              >æ¼”è®²ç¨¿å†…å®¹ (è¯·æŒ‰æ¢è¡Œé”®åˆ†éš”è¡Œ)</label
            >
            <!-- é€‚é…æ¨ªå±å’Œæ¡Œé¢ï¼šé»˜è®¤é«˜ 6rem (h-24)ï¼Œä¸­ç­‰å±å¹•ä»¥ä¸Šé«˜ 9rem (md:h-36) -->
            <textarea
              id="script-input"
              class="w-full h-24 md:h-36 p-2 mt-1 rounded-lg bg-gray-700 text-gray-200 focus:ring-primary focus:border-primary border border-gray-600"
            >
å„ä½è§‚ä¼—å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°ä»Šå¤©çš„åˆ†äº«ä¼šã€‚

ä¿¡æ¯æ—¶ä»£ï¼Œæˆ‘ä»¬å¸¸è¢«æ•°å­—ä¸–ç•Œçš„æ··ä¹±æ‰€å›°æ‰°ã€‚
ä½ æ˜¯ä¸æ˜¯ä¹Ÿå¸¸è¢«ç”µè„‘ã€æ‰‹æœºã€ç½‘ç›˜é‡Œçš„æ–‡ä»¶æå¾—ç„¦å¤´çƒ‚é¢ï¼Ÿ
æ˜æ˜ä¿å­˜è¿‡çš„ä¸œè¥¿ï¼Œååæ€¥ç”¨æ—¶ç¿»éå…¨ç½‘éƒ½æ‰¾ä¸åˆ°ï¼Ÿ

åˆ«æ€¥ï¼Œä»Šå¤©æˆ‘è¦ç»™ä½ åˆ†äº«ä¸€ä¸ªè¶…ç®€å•çš„æ–¹æ³•â€”â€”PARAï¼
åªéœ€è¦4ä¸ªæ–‡ä»¶å¤¹ï¼Œå°±èƒ½è®©ä½ çš„æ•°å­—ç”Ÿæ´»ç¬é—´å˜æ¸…çˆ½ï¼Œæ‰¾ä¸œè¥¿å†ä¹Ÿä¸æŠ“ç‹‚ã€‚

é¡¹ç›®ï¼ˆProjectsï¼‰æ”¾ä½ çœ¼ä¸‹æ­£åœ¨å¿™çš„äº‹ã€‚
é¢†åŸŸï¼ˆAreasï¼‰æ”¾ä½ ç”Ÿæ´»ä¸­éœ€è¦æŒç»­å…³æ³¨çš„å¤§å—é¢†åŸŸã€‚
èµ„æºï¼ˆResourcesï¼‰æ”¾ä½ æ„Ÿå…´è¶£æˆ–æ­£åœ¨å­¦ä¹ çš„çŸ¥è¯†åº“ã€‚
å½’æ¡£ï¼ˆArchivesï¼‰æ”¾è¿‡å»å®Œæˆæˆ–æš‚æ—¶ç”¨ä¸ä¸Šçš„ä¸œè¥¿ã€‚

å¯¹ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ï¼è¿™å››ä¸ªæ–‡ä»¶å¤¹ï¼Œæ¶µç›–äº†ä½ æ•°å­—ç”Ÿæ´»çš„æ‰€æœ‰ä¸œè¥¿ã€‚
å·¥ä½œä»»åŠ¡ã€ä¸ªäººå…´è¶£ï¼ŒPARAéƒ½èƒ½å¸®ä½ åˆ†å¾—æ¸…æ¸…æ¥šæ¥šã€‚
æˆ‘è‡ªå·±è¯•äº†ä»¥åï¼ŒçœŸçš„æœ‰ç§â€œæ•‘å‘½å•Šç»ˆäºæ‰¾åˆ°ç»„ç»‡ç¥å™¨â€çš„æ„Ÿè§‰ï¼
è¯•ä¸€æ¬¡ï¼Œä½ å°±çŸ¥é“æœ‰å¤šçˆ½ï¼
æ„Ÿè°¢å¤§å®¶çš„æ”¶å¬ï¼ŒæœŸå¾…ä¸ä½ ä¸‹æœŸå†è§ï¼peaceï½
                    </textarea
            >
          </div>
        </div>
      </div>
      <!-- END OF BOTTOM WRAPPER -->
    </div>

    <script>
      // å…¨å±€å˜é‡
      let scrollAnimFrameId = null; // NEW: æ›¿æ¢ scrollInterval
      let isScrolling = false;
      let isVoiceMode = false;
      let isMirrored = false;
      let isFullscreen = false;
      let recognition = null;
      let scriptSegments = []; // ç°åœ¨å­˜å‚¨çš„æ˜¯æ¯ä¸€è¡Œ
      let currentSegmentIndex = 0; // ç°åœ¨ä»£è¡¨å½“å‰è¡Œç´¢å¼•

      // DOM å…ƒç´ 
      const headerWrapper = document.getElementById("header-wrapper");
      const bottomControlsWrapper = document.getElementById(
        "bottom-controls-wrapper"
      );
      const display = document.getElementById("script-content-wrapper");
      const input = document.getElementById("script-input");
      const startStopBtn = document.getElementById("start-stop-btn");
      const resetBtn = document.getElementById("reset-btn");
      const speedInput = document.getElementById("scroll-speed");
      const speedValue = document.getElementById("speed-value");
      const fontInput = document.getElementById("font-size");
      const fontValue = document.getElementById("font-value");
      const paddingInput = document.getElementById("text-padding");
      const paddingValue = document.getElementById("padding-value");
      const paragraphInput = document.getElementById("paragraph-spacing");
      const paragraphValue = document.getElementById("paragraph-value");
      const lineHeightInput = document.getElementById("line-height-control");
      const lineHeightValue = document.getElementById("line-height-value");
      const mirrorToggleBtn = document.getElementById("mirror-toggle-btn");
      const fullscreenBtn = document.getElementById("fullscreen-btn");
      const fsOverlayControls = document.getElementById("fs-overlay-controls");
      const fsPauseIcon = document.getElementById("fs-pause-icon");
      const fsPlayIcon = document.getElementById("fs-play-icon");
      const exitFsBtn = document.getElementById("exit-fs-btn");

      const statusMessage = document.getElementById("status-message");
      const modeToggleBtn = document.getElementById("mode-toggle-btn");
      const recognitionHint = document.getElementById("recognition-hint");

      // --- è¾…åŠ©å‡½æ•° ---

      /**
       * æ¸²æŸ“è„šæœ¬åˆ°æè¯å™¨æ˜¾ç¤ºåŒº (ç°åœ¨æ˜¯æŒ‰è¡Œåˆ†å‰²)
       */
      function renderScript() {
        const lines = input.value.split("\n");
        scriptSegments = lines;

        display.innerHTML = "";
        const currentParagraphSpacing = paragraphInput.value;
        const currentLineHeight = lineHeightInput.value;
        const lineVPadding = "8px"; // å‚ç›´å†…è¾¹è·ï¼Œä½¿é«˜äº®æ•ˆæœæ›´æ˜æ˜¾

        scriptSegments.forEach((segment, index) => {
          const div = document.createElement("div");
          // å¦‚æœæ˜¯ç©ºè¡Œï¼Œç”¨ &nbsp; ä¿æŒç©ºé—´ï¼Œå¹¶ç”¨ä½œæ®µè½åˆ†éš”
          const content = segment.trim() === "" ? "&nbsp;" : segment.trim();

          div.className =
            "script-segment text-2xl md:text-3xl lg:text-4xl font-semibold opacity-70 transition-all duration-300";
          div.id = `segment-${index}`;
          div.innerHTML = content;
          div.style.fontSize = `${fontInput.value}px`;
          div.style.lineHeight = currentLineHeight;

          if (segment.trim() === "") {
            // è¿™æ˜¯æ®µè½é—´çš„ç©ºè¡Œ
            div.style.marginBottom = `${currentParagraphSpacing}px`;
            div.style.height = "0"; // ç¡®ä¿ç©ºè¡Œæœ¬èº«ä¸å æ®å¤šä½™çš„é«˜åº¦
            div.style.padding = "0";
          } else {
            // è¿™æ˜¯å†…å®¹è¡Œ
            div.style.paddingTop = lineVPadding;
            div.style.paddingBottom = lineVPadding;
            div.style.marginBottom = "0px";
          }

          // å¦‚æœå½“å‰å¤„äºé•œåƒçŠ¶æ€ï¼Œæ–°æ¸²æŸ“çš„è¡Œä¹Ÿè¦ç¿»è½¬å›æ¥
          if (isMirrored) {
            div.style.transform = "scaleX(-1)";
          }

          display.appendChild(div);
        });

        // é¦–æ¬¡æ¸²æŸ“åï¼Œé‡ç½®å¹¶æ¿€æ´»ç¬¬ä¸€ä¸ªæ®µè½
        resetPosition();
        updateActiveSegment();

        // åªæœ‰æ‰€æœ‰è¡Œéƒ½ä¸ºç©ºæ—¶æ‰ç¦ç”¨å¯åŠ¨æŒ‰é’®
        updateStartButtonState();
      }

      /**
       * æ£€æŸ¥å†…å®¹æ˜¯å¦å¯æ»šåŠ¨å¹¶æ›´æ–°å¯åŠ¨æŒ‰é’®çŠ¶æ€
       */
      function updateStartButtonState() {
        const hasContent =
          scriptSegments.length > 0 &&
          scriptSegments.some((s) => s.trim() !== "");

        if (!hasContent) {
          startStopBtn.disabled = true;
          return;
        }

        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿DOMå¸ƒå±€å®Œæˆä¸”scrollHeightè®¡ç®—å‡†ç¡®
        setTimeout(() => {
          // æ£€æŸ¥å†…å®¹æ˜¯å¦æº¢å‡ºå®¹å™¨
          const isScrollable = display.scrollHeight > display.clientHeight;
          startStopBtn.disabled = !isScrollable;

          if (!isScrollable && !isVoiceMode) {
            statusMessage.innerText =
              "âš ï¸ è„šæœ¬å†…å®¹å¤ªçŸ­ï¼Œæ— æ³•å¯åŠ¨æ»šåŠ¨ã€‚è¯·æ·»åŠ æ›´å¤šæ–‡æœ¬ã€‚";
          } else {
            statusMessage.innerText = "";
          }
        }, 50); // 50ms å»¶è¿Ÿç¡®ä¿å¸ƒå±€å®Œæˆ
      }

      /**
       * æ›´æ–°å½“å‰æ´»åŠ¨çš„æ®µè½/è¡Œæ ·å¼
       */
      function updateActiveSegment() {
        document.querySelectorAll(".script-segment").forEach((el, index) => {
          el.classList.remove("active-segment", "opacity-100");

          if (index === currentSegmentIndex) {
            el.classList.add("active-segment", "opacity-100");
            el.classList.remove("opacity-70", "opacity-30");
          } else if (index < currentSegmentIndex) {
            // å·²è¯»è¿‡çš„è¡Œå˜æ·¡
            el.classList.add("opacity-30");
            el.classList.remove("opacity-70");
          } else {
            // æœªè¯»è¿‡çš„è¡Œä¿æŒä¸­ç­‰äº®åº¦
            el.classList.add("opacity-70");
            el.classList.remove("opacity-30");
          }
        });
      }

      /**
       * æ ¹æ®å½“å‰æ»šåŠ¨ä½ç½®æ›´æ–°æ´»åŠ¨æ®µè½
       */
      function updateSegmentByScrollPosition() {
        // å¦‚æœåœ¨è‡ªåŠ¨æ»šåŠ¨æˆ–è¯­éŸ³æ¨¡å¼ä¸‹ï¼Œåˆ™ä¸é€šè¿‡æ»šåŠ¨ä½ç½®æ¥æ›´æ–°æ´»åŠ¨æ®µè½ï¼Œä»¥å…å†²çª
        if (isScrolling || isVoiceMode) return;

        const segments = document.querySelectorAll(".script-segment");
        if (segments.length === 0) return;

        const displayRect = document
          .getElementById("teleprompter-display")
          .getBoundingClientRect();
        // ç›®æ ‡ä½ç½®ï¼šæè¯å™¨æ˜¾ç¤ºåŒºå‚ç›´ä¸­ç‚¹çš„ç»å¯¹ä½ç½®
        const centerOffset = displayRect.top + displayRect.height / 2;

        let bestIndex = currentSegmentIndex; // é»˜è®¤å€¼
        let minDistance = Infinity;

        segments.forEach((el, index) => {
          // å¿½ç•¥ç©ºè¡Œï¼ˆæ®µè½åˆ†éš”ç¬¦ï¼‰çš„åŒ¹é…
          if (scriptSegments[index].trim() === "") return;

          const rect = el.getBoundingClientRect();
          // æ®µè½ä¸­å¿ƒç‚¹ç›¸å¯¹äºå±å¹•é¡¶éƒ¨çš„ç»å¯¹ä½ç½®
          const elCenter = rect.top + rect.height / 2;

          // æ®µè½ä¸­å¿ƒç‚¹ä¸æè¯å™¨ä¸­çº¿çš„è·ç¦»
          const distance = Math.abs(elCenter - centerOffset);

          if (distance < minDistance) {
            minDistance = distance;
            bestIndex = index;
          }
        });

        if (bestIndex !== currentSegmentIndex) {
          currentSegmentIndex = bestIndex;
          updateActiveSegment();
        }
      }

      /**
       * å¹³æ»‘æ»šåŠ¨åˆ°å½“å‰æ´»åŠ¨æ®µè½çš„ä¸­å¤®
       */
      function smoothScrollToActiveSegment() {
        const activeSegment = document.getElementById(
          `segment-${currentSegmentIndex}`
        );
        if (activeSegment) {
          // ä½¿ç”¨ scrollIntoView å±…ä¸­å¯¹é½
          activeSegment.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }
      }

      /**
       * æ£€æŸ¥ Web Speech API å…¼å®¹æ€§
       */
      function checkSpeechApi() {
        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          statusMessage.innerText =
            "âš ï¸ è­¦å‘Š: æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API (è¯­éŸ³è¯†åˆ«)ã€‚æ™ºèƒ½è¯­éŸ³æ¨¡å¼å°†ä¸å¯ç”¨ã€‚";
          modeToggleBtn.disabled = true;
          return false;
        }
        statusMessage.innerText = "";
        return true;
      }

      /**
       * æ›´æ–°å…¨å±æ¨¡å¼ä¸‹çš„æš‚åœ/æ’­æ”¾å›¾æ ‡
       */
      function updateFullscreenIcons() {
        if (!isFullscreen) return;
        if (isScrolling) {
          fsPauseIcon.classList.remove("hidden");
          fsPlayIcon.classList.add("hidden");
        } else {
          fsPauseIcon.classList.add("hidden");
          fsPlayIcon.classList.remove("hidden");
        }
      }

      // --- æ ¸å¿ƒæ¨¡å¼é€»è¾‘ï¼šæ‰‹åŠ¨æ»šåŠ¨ (ä½¿ç”¨ requestAnimationFrame) ---

      /**
       * æ»šåŠ¨å¾ªç¯ (ä½¿ç”¨ requestAnimationFrame)
       */
      function scrollLoop() {
        if (!isScrolling) return;

        const speed = parseFloat(speedInput.value);

        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾åº•éƒ¨ï¼Œç•™å‡º5pxçš„ç¼“å†²
        if (
          display.scrollTop + display.clientHeight >=
          display.scrollHeight - 5
        ) {
          stopScroll();
          return;
        }

        // åº”ç”¨æ»šåŠ¨
        display.scrollTop += speed;

        // ç»§ç»­ä¸‹ä¸€å¸§çš„å¾ªç¯
        scrollAnimFrameId = requestAnimationFrame(scrollLoop);
      }

      function startScroll() {
        if (isScrolling) return;

        // 1. ç¡®ä¿å†…å®¹å¯æ»šåŠ¨
        if (display.scrollHeight <= display.clientHeight) {
          statusMessage.innerText =
            "âš ï¸ è„šæœ¬å†…å®¹å¤ªçŸ­ï¼Œæ— éœ€æ»šåŠ¨ã€‚è¯·æ·»åŠ æ›´å¤šæ–‡æœ¬ã€‚";
          console.warn(
            "Cannot start scroll: ScrollHeight is not greater than ClientHeight."
          );
          stopScroll(); // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ˜¯åœæ­¢
          return;
        }

        isScrolling = true;
        startStopBtn.innerText = "æš‚åœæ»šåŠ¨";
        startStopBtn.classList.remove("bg-green-600", "hover:bg-green-500");
        startStopBtn.classList.add("bg-orange-600", "hover:bg-orange-500");

        updateFullscreenIcons();

        // 2. å¯åŠ¨ requestAnimationFrame å¾ªç¯
        scrollLoop();
      }

      function stopScroll() {
        if (!isScrolling) return;
        isScrolling = false;

        // ä½¿ç”¨ cancelAnimationFrame åœæ­¢å¾ªç¯
        if (scrollAnimFrameId) {
          cancelAnimationFrame(scrollAnimFrameId);
          scrollAnimFrameId = null;
        }

        startStopBtn.innerText = "å¯åŠ¨æ»šåŠ¨";
        startStopBtn.classList.remove("bg-orange-600", "hover:bg-orange-500");
        startStopBtn.classList.add("bg-green-600", "hover:bg-green-500");

        updateFullscreenIcons();
      }

      // --- æ ¸å¿ƒæ¨¡å¼é€»è¾‘ï¼šè¯­éŸ³æ™ºèƒ½æ¨è¿› ---

      function initSpeechRecognition() {
        if (!checkSpeechApi()) return;

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false; // åªå¬ä¸€å¥
        recognition.interimResults = false; // åªè¿”å›æœ€ç»ˆç»“æœ
        recognition.lang = "zh-CN"; // è®¾ç½®ä¸­æ–‡è¯†åˆ«

        recognition.onstart = () => {
          recognitionHint.innerText = "ğŸ™ï¸ æ­£åœ¨å¬... è¯·è¯´å½“å‰è¡Œ";
          recognitionHint.classList.add("visible");
          statusMessage.innerText = "è¯­éŸ³æ¨¡å¼å·²å¯åŠ¨ï¼Œè¯·å¼€å§‹æœ—è¯»ã€‚";
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          console.log("è¯†åˆ«ç»“æœ:", transcript);
          checkAndAdvance(transcript);
        };

        recognition.onend = () => {
          recognitionHint.classList.remove("visible");
          if (isVoiceMode) {
            // å¦‚æœæœªå®Œæˆï¼Œè‡ªåŠ¨é‡æ–°å¯åŠ¨ç›‘å¬
            setTimeout(() => {
              if (isVoiceMode && currentSegmentIndex < scriptSegments.length) {
                try {
                  recognition.start();
                } catch (e) {
                  console.warn(
                    "Recognition already started, ignoring auto-restart."
                  );
                }
              } else if (currentSegmentIndex >= scriptSegments.length) {
                statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼";
              }
            }, 100);
          }
        };

        recognition.onerror = (event) => {
          console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
          statusMessage.innerText = `âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}. è¯·æ£€æŸ¥éº¦å…‹é£æƒé™ã€‚`;
          recognitionHint.classList.remove("visible");
          if (isVoiceMode) {
            // é”™è¯¯åå°è¯•é‡æ–°å¯åŠ¨
            setTimeout(() => {
              if (isVoiceMode && currentSegmentIndex < scriptSegments.length) {
                try {
                  recognition.start();
                } catch (e) {}
              }
            }, 1000);
          }
        };
      }

      function startVoiceControl() {
        if (!recognition) initSpeechRecognition();
        isVoiceMode = true;
        startStopBtn.disabled = true; // è¯­éŸ³æ¨¡å¼ä¸‹ç¦ç”¨æ‰‹åŠ¨å¯åŠ¨æŒ‰é’®
        speedInput.disabled = true;
        fullscreenBtn.disabled = true;

        modeToggleBtn.innerText = "åˆ‡æ¢åˆ° æ‰‹åŠ¨æ¨¡å¼";
        modeToggleBtn.classList.remove("bg-yellow-600", "hover:bg-yellow-500");
        modeToggleBtn.classList.add("bg-purple-600", "hover:bg-purple-500");

        stopScroll(); // ç¡®ä¿æ‰‹åŠ¨æ»šåŠ¨å·²åœæ­¢

        // ç¡®ä¿å½“å‰è¡Œæ˜¯å±…ä¸­ä¸”å¯è¯»çš„
        smoothScrollToActiveSegment();

        if (currentSegmentIndex < scriptSegments.length) {
          recognition.start();
        } else {
          statusMessage.innerText = "è¯·ç‚¹å‡»é‡ç½®æŒ‰é’®å¼€å§‹æœ—è¯»ã€‚";
        }
      }

      function stopVoiceControl() {
        isVoiceMode = false;
        // åªæœ‰æ‰€æœ‰è¡Œéƒ½ä¸ºç©ºæ—¶æ‰ç¦ç”¨å¯åŠ¨æŒ‰é’®
        updateStartButtonState(); // ä½¿ç”¨æ–°çš„æ£€æŸ¥å‡½æ•°
        speedInput.disabled = false;
        fullscreenBtn.disabled = false;

        modeToggleBtn.innerText = "åˆ‡æ¢åˆ° è¯­éŸ³æ¨¡å¼";
        modeToggleBtn.classList.remove("bg-purple-600", "hover:bg-purple-500");
        modeToggleBtn.classList.add("bg-yellow-600", "hover:bg-yellow-500");

        recognitionHint.classList.remove("visible");
        statusMessage.innerText = "å·²åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";

        if (recognition) {
          recognition.stop();
        }
      }

      /**
       * æ£€æŸ¥è¯†åˆ«ç»“æœå¹¶æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªè¡Œ
       * @param {string} transcript è¯†åˆ«çš„æ–‡æœ¬
       */
      function checkAndAdvance(transcript) {
        if (!isVoiceMode || currentSegmentIndex >= scriptSegments.length)
          return;

        // 1. è·³è¿‡æ‰€æœ‰ç©ºè¡Œ
        while (
          currentSegmentIndex < scriptSegments.length &&
          scriptSegments[currentSegmentIndex].trim() === ""
        ) {
          currentSegmentIndex++;
        }
        if (currentSegmentIndex >= scriptSegments.length) {
          stopVoiceControl();
          statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";
          return;
        }

        const currentLine = scriptSegments[currentSegmentIndex];
        // å°è¯•åŒ¹é…å½“å‰è¡Œå¼€å¤´çš„è¾ƒå°ç‰‡æ®µ (8-15ä¸ªå­—ç¬¦)
        const matchText = currentLine
          .replace(/[ï¼Œã€‚ï¼ï¼Ÿ]/g, "")
          .trim()
          .slice(0, 15);

        // åŒ¹é…é€»è¾‘ï¼šå¦‚æœè¯†åˆ«ç»“æœåŒ…å«äº†å½“å‰è¡Œå¤§éƒ¨åˆ†æ–‡æœ¬æˆ–å…³é”®å¼€å¤´
        // åˆ¤æ–­æ ‡å‡†: 1. è¯†åˆ«æ–‡æœ¬åŒ…å«ç›®æ ‡è¡Œå¼€å¤´8ä¸ªå­—ç¬¦
        // OR 2. è¯†åˆ«æ–‡æœ¬é•¿åº¦è¾¾åˆ°ç›®æ ‡æ–‡æœ¬é•¿åº¦çš„ä¸€åŠ AND è¯†åˆ«æ–‡æœ¬åŒ…å«ç›®æ ‡æ–‡æœ¬å¼€å¤´3ä¸ªå­—ç¬¦
        const isMatch =
          transcript.includes(matchText.slice(0, 0)) ||
          (transcript.length > matchText.length * 0.5 &&
            transcript.includes(matchText.slice(0, 3)));

        if (isMatch) {
          console.log(
            `Matched line ${currentSegmentIndex + 1}: "${currentLine.slice(
              0,
              10
            )}..."`
          );
          currentSegmentIndex++;
          updateActiveSegment();
          smoothScrollToActiveSegment(); // æ»šåŠ¨åˆ°ä¸‹ä¸€è¡Œ

          if (currentSegmentIndex < scriptSegments.length) {
            // ç»§ç»­ç›‘å¬ä¸‹ä¸€ä¸ªè¡Œ
            setTimeout(() => {
              if (isVoiceMode) recognition.start();
            }, 500);
          } else {
            // è„šæœ¬æœ—è¯»å®Œæ¯•
            stopVoiceControl();
            statusMessage.innerText = "âœ… è„šæœ¬æœ—è¯»å®Œæ¯•ï¼åˆ‡æ¢å›æ‰‹åŠ¨æ¨¡å¼ã€‚";
          }
        } else {
          // æœªåŒ¹é…ï¼Œç»§ç»­ç›‘å¬
          setTimeout(() => {
            if (isVoiceMode) recognition.start();
          }, 500);
        }
      }

      /**
       * åˆ‡æ¢é•œåƒçŠ¶æ€
       */
      function toggleMirroring() {
        isMirrored = !isMirrored;
        const segments = document.querySelectorAll(".script-segment");

        if (isMirrored) {
          // 1. ç¿»è½¬å†…å®¹å®¹å™¨ (Wrapper)
          display.style.transform = "scaleX(-1)";
          // 2. ç¿»è½¬å†…éƒ¨æ–‡æœ¬ (Segments) ä½¿å…¶å¯è¯»
          segments.forEach((el) => {
            el.style.transform = "scaleX(-1)";
          });
          mirrorToggleBtn.innerText = "å…³é—­é•œåƒ";
          mirrorToggleBtn.classList.remove("bg-gray-600", "hover:bg-gray-500");
          mirrorToggleBtn.classList.add("bg-blue-600", "hover:bg-blue-500");
        } else {
          // 1. æ¢å¤å†…å®¹å®¹å™¨
          display.style.transform = "none";
          // 2. æ¢å¤å†…éƒ¨æ–‡æœ¬
          segments.forEach((el) => {
            el.style.transform = "none";
          });
          mirrorToggleBtn.innerText = "å¼€å¯é•œåƒ";
          mirrorToggleBtn.classList.remove("bg-blue-600", "hover:bg-blue-500");
          mirrorToggleBtn.classList.add("bg-gray-600", "hover:bg-gray-500");
        }
      }

      /**
       * åˆ‡æ¢å…¨å±çŠ¶æ€
       */
      function toggleFullscreen() {
        isFullscreen = !isFullscreen;

        if (isFullscreen) {
          // ç¦ç”¨è¯­éŸ³æ¨¡å¼ï¼Œé˜²æ­¢å†²çª
          if (isVoiceMode) stopVoiceControl();

          // éšè—æ‰€æœ‰éæ˜¾ç¤ºåŒºå…ƒç´ 
          document.body.classList.add("overflow-hidden");
          headerWrapper.classList.add("hidden");
          bottomControlsWrapper.classList.add("hidden");

          // æè¯å™¨æ˜¾ç¤ºåŒºè¿›å…¥å…¨å±
          document
            .getElementById("teleprompter-display")
            .classList.add("is-fullscreen");

          // æ˜¾ç¤ºå…¨å±æ§åˆ¶å±‚å’Œé€€å‡ºæŒ‰é’®
          fsOverlayControls.classList.remove("hidden");
          fsOverlayControls.classList.add("flex");
          exitFsBtn.classList.remove("hidden"); // æ˜¾ç¤ºé€€å‡ºæŒ‰é’®

          // åˆ‡æ¢æŒ‰é’®æ–‡å­—
          fullscreenBtn.innerText = "é€€å‡ºå…¨å±";

          // æ›´æ–°å…¨å±å›¾æ ‡çŠ¶æ€
          updateFullscreenIcons();

          // ç¡®ä¿åœ¨å…¨å±çŠ¶æ€ä¸‹ï¼ŒæŒ‰é’®çŠ¶æ€åŸºäºå†…å®¹é•¿åº¦
          updateStartButtonState();
        } else {
          // é€€å‡ºå…¨å±
          document.body.classList.remove("overflow-hidden");
          headerWrapper.classList.remove("hidden");
          bottomControlsWrapper.classList.remove("hidden");

          document
            .getElementById("teleprompter-display")
            .classList.remove("is-fullscreen");

          // éšè—å…¨å±æ§åˆ¶å±‚å’Œé€€å‡ºæŒ‰é’®
          fsOverlayControls.classList.add("hidden");
          fsOverlayControls.classList.remove("flex");
          exitFsBtn.classList.add("hidden"); // éšè—é€€å‡ºæŒ‰é’®

          // åˆ‡æ¢æŒ‰é’®æ–‡å­—
          fullscreenBtn.innerText = "å…¨å±æ˜¾ç¤º";

          // é€€å‡ºå…¨å±æ—¶åœæ­¢æ»šåŠ¨
          stopScroll();
          updateStartButtonState(); // é€€å‡ºå…¨å±åæ›´æ–°æŒ‰é’®çŠ¶æ€
        }
      }

      /**
       * å…¨å±æ¨¡å¼ä¸‹çš„ç‚¹å‡»äº‹ä»¶å¤„ç† (æš‚åœ/æ’­æ”¾)
       */
      function handleFullscreenClick() {
        if (isFullscreen && !isVoiceMode) {
          if (isScrolling) {
            stopScroll();
          } else {
            if (!startStopBtn.disabled) {
              startScroll();
            }
          }
        }
      }

      // --- äº‹ä»¶ç›‘å¬ ---

      // æ¨¡å¼åˆ‡æ¢
      modeToggleBtn.addEventListener("click", () => {
        if (isVoiceMode) {
          stopVoiceControl();
        } else {
          // è¯­éŸ³æ¨¡å¼ä¸å…¨å±æ»šåŠ¨äº’æ–¥
          if (isFullscreen) {
            statusMessage.innerText = "âš ï¸ è¯·å…ˆé€€å‡ºå…¨å±ï¼Œå†åˆ‡æ¢åˆ°è¯­éŸ³æ¨¡å¼ã€‚";
            return;
          }
          startVoiceControl();
        }
      });

      // æ‰‹åŠ¨å¯åŠ¨/åœæ­¢
      startStopBtn.addEventListener("click", () => {
        if (isVoiceMode) return;
        isScrolling ? stopScroll() : startScroll();
      });

      // é•œåƒåˆ‡æ¢
      mirrorToggleBtn.addEventListener("click", toggleMirroring);

      // å…¨å±åˆ‡æ¢ (æ§åˆ¶é¢æ¿æŒ‰é’®)
      fullscreenBtn.addEventListener("click", () => {
        if (isVoiceMode) {
          statusMessage.innerText =
            "âš ï¸ è¯­éŸ³æ¨¡å¼ä¸‹æ— æ³•è¿›å…¥å…¨å±æ»šåŠ¨æ¨¡å¼ã€‚è¯·å…ˆåˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼ã€‚";
          return;
        }
        toggleFullscreen();
      });

      // NEW: é€€å‡ºå…¨å±æŒ‰é’® (å›ºå®šåœ¨å³ä¸Šè§’çš„æŒ‰é’®)
      exitFsBtn.addEventListener("click", toggleFullscreen);

      // å…¨å±æ¨¡å¼ä¸‹ç‚¹å‡»æè¯å™¨åŒºåŸŸå®ç°æš‚åœ/æ’­æ”¾
      document
        .getElementById("teleprompter-display")
        .addEventListener("click", handleFullscreenClick);

      // ç›‘å¬ Esc é”®é€€å‡ºå…¨å±
      document.addEventListener("keydown", (e) => {
        if (isFullscreen && e.key === "Escape") {
          toggleFullscreen();
        }
      });

      // ç›‘å¬æè¯å™¨åŒºåŸŸçš„æ»šåŠ¨äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°æ´»åŠ¨æ®µè½ï¼ˆç”¨æˆ·æ‰‹åŠ¨æ“ä½œæ—¶ï¼‰
      display.addEventListener("scroll", updateSegmentByScrollPosition);

      // ç›‘å¬é”®ç›˜äº‹ä»¶ï¼Œç”¨äºè“ç‰™é¥æ§å™¨æ§åˆ¶
      document.addEventListener("keydown", (e) => {
        // ç¡®ä¿è¾“å…¥æ¡†æ²¡æœ‰èšç„¦ï¼Œé˜²æ­¢è¾“å…¥æ–‡å­—æ—¶è§¦å‘æ§åˆ¶
        if (input === document.activeElement) return;

        // è“ç‰™é¥æ§å™¨é€šå¸¸æ¨¡æ‹Ÿ Space, Enter, æˆ– Arrow Keys

        // 1. å…¨å±€æ’­æ”¾/æš‚åœ (Spacebar æˆ– Enter/Return)
        if (e.code === "Space" || e.key === "Enter") {
          e.preventDefault();
          if (isVoiceMode) return; // è¯­éŸ³æ¨¡å¼ä¸å“åº”

          if (isFullscreen && !startStopBtn.disabled) {
            handleFullscreenClick();
          } else if (!isFullscreen && !startStopBtn.disabled) {
            isScrolling ? stopScroll() : startScroll();
          }
        }

        // 2. å¾®è°ƒæ»šåŠ¨ (Arrow Up/Down) - ä»…åœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹è¿›è¡Œ
        if (!isVoiceMode) {
          const scrollStep = 40; // æ¯æ¬¡è°ƒæ•´40åƒç´ 
          let scrolled = false;

          if (e.key === "ArrowDown") {
            e.preventDefault();
            // åªæœ‰åœ¨éè‡ªåŠ¨æ»šåŠ¨æ—¶æ‰å…è®¸å¾®è°ƒ
            if (!isScrolling) {
              display.scrollTop += scrollStep;
              scrolled = true;
            }
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            if (!isScrolling) {
              display.scrollTop -= scrollStep;
              scrolled = true;
            }
          }

          // å¦‚æœè¿›è¡Œäº†å¾®è°ƒï¼Œæ‰‹åŠ¨è§¦å‘æ´»åŠ¨æ®µè½æ›´æ–°
          if (scrolled) {
            // å»¶è¿Ÿè°ƒç”¨ï¼Œç¡®ä¿æ»šåŠ¨å®Œæˆåæ®µè½ä½ç½®è®¡ç®—å‡†ç¡®
            setTimeout(updateSegmentByScrollPosition, 100);
          }
        }
      });

      // é‡ç½®æŒ‰é’®
      resetBtn.addEventListener("click", () => {
        stopScroll();
        if (isVoiceMode) stopVoiceControl();
        resetPosition();
      });

      function resetPosition() {
        currentSegmentIndex = 0;
        display.scrollTop = 0; // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œè®©ç¬¬ä¸€ä¸ªæ®µè½å¯è§
        updateActiveSegment();
        if (isVoiceMode && scriptSegments.length > 0) {
          startVoiceControl(); // å¦‚æœåœ¨è¯­éŸ³æ¨¡å¼ä¸‹é‡ç½®ï¼Œåˆ™é‡æ–°å¯åŠ¨ç›‘å¬
        }
      }

      // è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“è„šæœ¬
      input.addEventListener("input", () => {
        renderScript();
        stopScroll(); // ç¡®ä¿ä¿®æ”¹è„šæœ¬æ—¶åœæ­¢æ»šåŠ¨
        if (isVoiceMode) stopVoiceControl(); // ç¡®ä¿ä¿®æ”¹è„šæœ¬æ—¶åœæ­¢è¯­éŸ³æ¨¡å¼
      });

      // é€Ÿåº¦å˜åŒ–
      speedInput.addEventListener("input", () => {
        speedValue.innerText = speedInput.value;
        // ä½¿ç”¨ rAF åï¼Œé€Ÿåº¦å˜åŒ–æ— éœ€åœæ­¢/é‡å¯ï¼Œç›´æ¥åœ¨ scrollLoop ä¸­ç”Ÿæ•ˆ
        // ä½†å¦‚æœå½“å‰æ²¡æœ‰æ»šåŠ¨ï¼Œéœ€è¦ç¡®ä¿ä¸‹æ¬¡å¯åŠ¨æ—¶çš„é€Ÿåº¦æ˜¯æ–°çš„
      });

      // å­—ä½“å˜åŒ–
      fontInput.addEventListener("input", () => {
        fontValue.innerText = `${fontInput.value}px`;
        document.querySelectorAll(".script-segment").forEach((el) => {
          el.style.fontSize = `${fontInput.value}px`;
          // ç¡®ä¿å­—ä½“å¤§å°å˜åŒ–åï¼Œé•œåƒæ ·å¼ä¿æŒ
          if (isMirrored) el.style.transform = "scaleX(-1)";
        });
        updateSegmentByScrollPosition(); // å­—ä½“å¤§å°å˜åŒ–å¯èƒ½å½±å“å½“å‰è¡Œä½ç½®
      });

      // æ–‡æœ¬è¾¹è·å˜åŒ– (Horizontal Padding)
      paddingInput.addEventListener("input", () => {
        const value = `${paddingInput.value}px`;
        paddingValue.innerText = value;
        // åº”ç”¨ padding åˆ°å†…å®¹ wrapper
        display.style.paddingLeft = value;
        display.style.paddingRight = value;
        updateSegmentByScrollPosition();
      });

      // æ®µè½é—´è·å˜åŒ– (Vertical Margin)
      paragraphInput.addEventListener("input", () => {
        const value = `${paragraphInput.value}px`;
        paragraphValue.innerText = value;
        // åº”ç”¨ margin-bottom åˆ°æ‰€æœ‰è„šæœ¬æ®µè½
        document.querySelectorAll(".script-segment").forEach((el, index) => {
          // åªæœ‰ç©ºè¡Œæ‰åº”ç”¨æ®µè½é—´è·
          if (scriptSegments[index].trim() === "") {
            el.style.marginBottom = value;
          }
        });
        updateSegmentByScrollPosition();
      });

      // è¡Œé«˜å˜åŒ– (Line Height)
      lineHeightInput.addEventListener("input", () => {
        const value = lineHeightInput.value;
        lineHeightValue.innerText = value;
        // åº”ç”¨ line-height åˆ°æ‰€æœ‰è„šæœ¬æ®µè½
        document.querySelectorAll(".script-segment").forEach((el) => {
          el.style.lineHeight = value;
        });
        updateSegmentByScrollPosition();
      });

      // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆç‰¹åˆ«æ˜¯é’ˆå¯¹ç§»åŠ¨ç«¯æ—‹è½¬å’Œåœ°å€æ æ˜¾ç¤º/éšè—ï¼‰
      window.addEventListener("resize", () => {
        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿DOMå°ºå¯¸ç¨³å®š
        setTimeout(updateStartButtonState, 200);
        // å¦‚æœæ­£åœ¨æ»šåŠ¨ï¼Œåœæ­¢å¹¶é‡æ–°æ£€æŸ¥æ»šåŠ¨çŠ¶æ€ï¼Œå› ä¸ºçª—å£å˜åŒ–ä¼šå½±å“æ»šåŠ¨è¾¹ç•Œ
        if (isScrolling) {
          stopScroll();
        }
        // ç¡®ä¿æ´»åŠ¨è¡Œä¿æŒåœ¨ä¸­å¿ƒ
        smoothScrollToActiveSegment();
      });

      // --- åˆå§‹åŒ– ---

      window.onload = function () {
        // 1. åˆå§‹åŒ–è„šæœ¬
        renderScript();

        // 2. æ£€æŸ¥è¯­éŸ³API
        checkSpeechApi();

        // 3. åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¯¹è±¡ (ä½†æš‚æ—¶ä¸å¯åŠ¨)
        initSpeechRecognition();

        // 4. åˆå§‹åŒ–UIçŠ¶æ€ (ä½¿ç”¨æ–°çš„æ£€æŸ¥ï¼Œå®ƒä¼šå»¶è¿Ÿæ‰§è¡Œ)
        updateStartButtonState();

        // 5. åº”ç”¨åˆå§‹æ–‡æœ¬è¾¹è·
        display.style.paddingLeft = `${paddingInput.value}px`;
        display.style.paddingRight = `${paddingInput.value}px`;

        // 6. åˆå§‹å®šä½
        resetPosition();
      };
    </script>
  </body>
</html>
